<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Chain Speedway ‚Äî ZK Gaming on Stellar</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="stellar-sdk.min.js"></script>
    <style>
        :root {
            --cyan:#00d4ff; --purple:#6b4aff; --green:#00ff88;
            --red:#ff4466; --gold:#ffd700; --orange:#ff8c00;
            --dark:#05050f; --card:#0d0d1f; --border:#2a2a4a;
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        html,body{height:100%;overflow:hidden;}
        body{font-family:'Orbitron',sans-serif;background:var(--dark);
            display:flex;justify-content:center;align-items:center;color:#fff;}
        body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
            background:radial-gradient(circle at 15% 50%,rgba(107,74,255,.08) 0%,transparent 50%),
                       radial-gradient(circle at 85% 50%,rgba(0,212,255,.08) 0%,transparent 50%);}

        /* MENU */
        .menu-toggle{position:fixed;top:12px;left:12px;z-index:1001;width:34px;height:34px;
            background:rgba(13,13,31,.95);border:1.5px solid var(--border);border-radius:8px;
            cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;transition:all .3s;}
        .menu-toggle:hover{border-color:var(--purple);}
        .menu-toggle span{width:15px;height:1.5px;background:var(--cyan);border-radius:2px;transition:all .3s;}
        .menu-toggle.active span:nth-child(1){transform:rotate(45deg) translate(4.5px,4.5px);}
        .menu-toggle.active span:nth-child(2){opacity:0;}
        .menu-toggle.active span:nth-child(3){transform:rotate(-45deg) translate(4.5px,-4.5px);}

        /* OVERLAY ‚Äî only covers right of sidebar */
        .sidebar-overlay{display:none;position:fixed;top:0;left:260px;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:998;cursor:pointer;}
        .sidebar-overlay.active{display:block;}

        /* LAYOUT */
        .main-container{position:relative;z-index:1;width:100%;height:100vh;display:flex;align-items:center;justify-content:center;}

        /* SIDEBAR */
        .sidebar{width:260px;background:var(--card);border-right:1px solid var(--border);
            padding:54px 12px 12px;display:flex;flex-direction:column;gap:10px;
            position:fixed;left:-270px;top:0;bottom:0;z-index:1000;overflow-y:auto;transition:left .3s ease;}
        .sidebar.open{left:0;}
        .sidebar::-webkit-scrollbar{width:3px;}
        .sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

        /* WALLET */
        .wallet-section{background:rgba(107,74,255,.08);border:1px solid rgba(107,74,255,.3);border-radius:10px;padding:12px;}
        .wallet-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
        .stellar-logo{width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,var(--cyan),var(--purple));
            display:flex;align-items:center;justify-content:center;font-weight:900;font-size:11px;flex-shrink:0;}
        .wallet-title{font-size:10px;font-weight:700;color:var(--cyan);letter-spacing:1px;text-transform:uppercase;}
        .wallet-status{font-size:9px;color:#666;margin-bottom:8px;font-family:'Share Tech Mono',monospace;}
        .wallet-status.connected{color:var(--green);}
        .connect-wallet-btn{width:100%;padding:8px;background:linear-gradient(135deg,var(--purple),var(--cyan));
            border:none;border-radius:7px;color:#fff;font-family:'Orbitron',sans-serif;font-size:9px;
            font-weight:700;cursor:pointer;letter-spacing:1px;transition:all .3s;text-transform:uppercase;}
        .connect-wallet-btn:hover{opacity:.85;}

        /* PRESTIGE */
        .prestige-section{background:rgba(255,215,0,.06);border:1px solid rgba(255,215,0,.25);border-radius:10px;padding:12px;}
        .prestige-title{font-size:10px;color:var(--gold);font-weight:700;letter-spacing:1px;margin-bottom:6px;text-transform:uppercase;}
        .prestige-info{font-size:8px;color:#666;font-family:'Share Tech Mono',monospace;line-height:1.9;}
        .prestige-info span{color:var(--gold);}
        .prestige-btn{width:100%;margin-top:8px;padding:7px;background:linear-gradient(135deg,#7a6000,var(--gold));
            border:none;border-radius:6px;color:#000;font-family:'Orbitron',sans-serif;font-size:8px;
            font-weight:900;cursor:pointer;text-transform:uppercase;opacity:.4;transition:all .3s;}
        .prestige-btn.available{opacity:1;animation:glow-gold 1.5s ease-in-out infinite;}
        @keyframes glow-gold{0%,100%{box-shadow:0 0 10px rgba(255,215,0,.3)}50%{box-shadow:0 0 25px rgba(255,215,0,.7)}}

        /* SHOP */
        .shop-section{background:rgba(0,255,136,.05);border:1px solid rgba(0,255,136,.2);border-radius:10px;padding:12px;}
        .shop-title{font-size:10px;color:var(--green);font-weight:700;letter-spacing:1px;margin-bottom:8px;text-transform:uppercase;}
        .upgrade-item{display:flex;justify-content:space-between;align-items:center;
            padding:6px 7px;border-radius:5px;margin-bottom:4px;background:rgba(255,255,255,.03);
            border:1px solid var(--border);cursor:pointer;transition:all .2s;}
        .upgrade-item:hover{border-color:var(--green);}
        .upgrade-item.owned{border-color:rgba(0,255,136,.4);background:rgba(0,255,136,.06);}
        .upgrade-item.maxed{opacity:.5;cursor:not-allowed;}
        .upgrade-name{font-size:8px;font-weight:700;color:#ccc;}
        .upgrade-desc{font-size:7px;color:#555;font-family:'Share Tech Mono',monospace;margin-top:1px;}
        .upgrade-cost{font-size:8px;color:var(--gold);font-weight:700;white-space:nowrap;}
        .upgrade-level{font-size:7px;color:var(--green);}

        /* LEADERBOARD */
        .leaderboard-section{background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.2);border-radius:10px;padding:12px;}
        .leaderboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
        .leaderboard-title{font-size:10px;color:var(--cyan);font-weight:700;letter-spacing:1px;text-transform:uppercase;}
        .zk-badge{font-size:7px;padding:2px 6px;background:rgba(0,255,136,.15);border:1px solid var(--green);border-radius:10px;color:var(--green);font-weight:700;}
        .leaderboard-list{max-height:150px;overflow-y:auto;}
        .leaderboard-entry{display:flex;align-items:center;gap:6px;padding:5px 6px;border-radius:5px;margin-bottom:3px;
            background:rgba(255,255,255,.02);border:1px solid transparent;font-size:8px;}
        .leaderboard-entry.top-1{border-color:rgba(255,215,0,.4);background:rgba(255,215,0,.06);}
        .leaderboard-entry.top-2{border-color:rgba(192,192,192,.4);}
        .leaderboard-entry.top-3{border-color:rgba(205,127,50,.4);}
        .entry-rank{width:18px;font-weight:900;color:var(--gold);}
        .entry-address{flex:1;font-family:'Share Tech Mono',monospace;color:#aaa;}
        .entry-score{color:var(--cyan);font-weight:700;}
        .entry-prestige{font-size:7px;color:var(--gold);}
        .empty-leaderboard{font-size:8px;color:#555;text-align:center;padding:14px 0;font-family:'Share Tech Mono',monospace;}

        /* GAME AREA */
        .game-container{display:flex;flex-direction:column;align-items:center;justify-content:center;
            width:100%;height:100vh;position:relative;gap:3px;padding:8px;}

        /* RESPONSIVE CANVAS WRAPPER */
        .canvas-scale-wrapper{
            position:relative;
            width:min(600px, calc(100vw - 40px));
            height:min(600px, calc(100vw - 40px));
            max-height:calc(100vh - 120px);
            flex-shrink:1;
        }
        canvas{display:block;width:100%;height:100%;border:2px solid var(--border);border-radius:4px;
            box-shadow:0 0 30px rgba(107,74,255,.2),0 0 60px rgba(0,212,255,.1);}
        canvas.danger{animation:lowHealth .5s ease-in-out infinite;border-color:var(--red) !important;}
        @keyframes lowHealth{0%,100%{box-shadow:0 0 0 0 rgba(255,68,102,0)}50%{box-shadow:0 0 0 6px rgba(255,68,102,.5)}}

        /* HUD */
        .game-hud{display:flex;justify-content:space-around;align-items:center;
            width:min(600px, calc(100vw - 40px));padding:6px 10px;
            background:rgba(13,13,31,.9);border:1px solid var(--border);border-radius:8px;flex-shrink:0;}
        .hud-item{text-align:center;}
        .hud-label{font-size:clamp(6px,1.5vw,8px);color:#555;letter-spacing:1px;text-transform:uppercase;}
        .hud-value{font-size:clamp(11px,2.5vw,14px);font-weight:700;color:var(--cyan);font-family:'Share Tech Mono',monospace;}
        .hud-value.fees{color:var(--gold);}
        .hud-value.block{color:var(--green);}
        .hud-value.priority{color:var(--purple);}

        /* FEE PROGRESS */
        #feeProgressBar{width:min(600px, calc(100vw - 40px)) !important;}
        #feeProgressLabel{width:min(600px, calc(100vw - 40px)) !important;font-size:8px;color:#555;text-align:center;font-family:'Share Tech Mono',monospace;}

        /* ZK BAR */
        .zk-live-bar{width:min(600px, calc(100vw - 40px));background:rgba(0,255,136,.04);
            border:1px solid rgba(0,255,136,.15);border-radius:5px;padding:4px 10px;
            display:none;align-items:center;gap:8px;font-family:'Share Tech Mono',monospace;font-size:8px;flex-shrink:0;}
        .zk-dot{width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0;animation:zkPulse 1.5s ease-in-out infinite;}
        @keyframes zkPulse{0%,100%{opacity:1}50%{opacity:.4}}
        .zk-live-text{color:#00ff88;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .zk-live-actions,.zk-live-seed{color:#444;font-size:7px;white-space:nowrap;}

        /* TOOLTIP */
        .tooltip{position:absolute;top:6px;left:50%;transform:translateX(-50%);
            background:rgba(13,13,31,.95);border:1px solid var(--cyan);border-radius:7px;
            padding:6px 12px;max-width:90%;font-size:9px;color:var(--cyan);text-align:center;
            font-family:'Share Tech Mono',monospace;line-height:1.5;z-index:100;
            opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;}
        .tooltip.show{opacity:1;}
        .tooltip.warning{border-color:var(--red);color:var(--red);}
        .tooltip.reward{border-color:var(--gold);color:var(--gold);}

        /* ALL OVERLAYS */
        .start-screen,.game-over-screen,.level-complete-screen,.countdown-overlay{
            position:absolute;inset:0;display:flex;flex-direction:column;
            align-items:center;justify-content:center;border-radius:4px;
            padding:16px;text-align:center;overflow-y:auto;gap:10px;}
        .start-screen{background:rgba(5,5,15,.97);z-index:50;}
        .start-screen.hidden{display:none;}
        .game-over-screen{background:rgba(5,5,15,.96);z-index:50;opacity:0;pointer-events:none;transition:opacity .3s;}
        .game-over-screen.active{opacity:1;pointer-events:all;}
        .level-complete-screen{background:rgba(5,5,15,.97);z-index:60;opacity:0;pointer-events:none;transition:opacity .35s;}
        .level-complete-screen.active{opacity:1;pointer-events:all;}
        .countdown-overlay{background:rgba(5,5,15,.82);z-index:70;opacity:0;pointer-events:none;transition:opacity .2s;}
        .countdown-overlay.active{opacity:1;}

        /* START SCREEN */
        .game-title{font-size:clamp(16px,5vw,26px);font-weight:900;
            background:linear-gradient(135deg,var(--cyan),var(--purple));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:2px;}
        .game-subtitle{font-size:8px;color:#555;letter-spacing:2px;text-transform:uppercase;font-family:'Share Tech Mono',monospace;}
        .narrative-box{background:rgba(107,74,255,.08);border:1px solid rgba(107,74,255,.3);
            border-radius:8px;padding:12px 14px;max-width:360px;width:100%;text-align:left;}
        .narrative-title{font-size:9px;color:var(--purple);font-weight:700;letter-spacing:1px;margin-bottom:6px;text-transform:uppercase;}
        .narrative-text{font-size:9px;color:#888;font-family:'Share Tech Mono',monospace;line-height:1.9;}
        .narrative-text span{color:var(--cyan);}
        .lane-info{display:flex;gap:8px;}
        .lane-tag{padding:5px 10px;border-radius:5px;font-size:8px;font-weight:700;border:1px solid;letter-spacing:1px;text-transform:uppercase;}
        .lane-slow{color:var(--green);border-color:var(--green);background:rgba(0,255,136,.08);}
        .lane-med{color:var(--gold);border-color:var(--gold);background:rgba(255,215,0,.08);}
        .lane-fast{color:var(--red);border-color:var(--red);background:rgba(255,68,102,.08);}
        .start-instructions{font-size:8px;color:#555;line-height:2;font-family:'Share Tech Mono',monospace;}
        .start-btn{font-family:'Orbitron',sans-serif;font-size:13px;font-weight:700;padding:13px 40px;
            background:linear-gradient(135deg,var(--purple),var(--cyan));border:none;border-radius:8px;
            color:#fff;cursor:pointer;text-transform:uppercase;letter-spacing:3px;
            box-shadow:0 6px 30px rgba(107,74,255,.5);animation:bounce 1.2s ease-in-out infinite;transition:all .3s;}
        .start-btn:hover{animation:none;transform:translateY(-3px);}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

        /* GAME OVER */
        .game-over-title{font-size:clamp(22px,5vw,32px);font-weight:900;color:var(--red);letter-spacing:4px;}
        .block-result{font-size:9px;color:#555;font-family:'Share Tech Mono',monospace;letter-spacing:1px;}
        .score-breakdown{background:rgba(107,74,255,.08);border:1px solid rgba(107,74,255,.3);
            border-radius:8px;padding:12px;width:100%;max-width:340px;}
        .score-row{display:flex;justify-content:space-between;font-size:9px;padding:3px 0;font-family:'Share Tech Mono',monospace;}
        .score-row .label{color:#666;}.score-row .val{color:var(--cyan);font-weight:700;}
        .score-row.total .label{color:var(--gold);font-weight:700;}.score-row.total .val{color:var(--gold);font-size:13px;}
        .zk-proof-status{font-size:9px;padding:8px 14px;border-radius:7px;
            background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.3);
            color:var(--green);width:100%;max-width:340px;font-family:'Share Tech Mono',monospace;display:none;}
        .zk-proof-status.generating{animation:pulse-green 1s infinite;}
        @keyframes pulse-green{0%,100%{border-color:rgba(0,255,136,.3)}50%{border-color:var(--green)}}
        .prestige-available-banner{background:rgba(255,215,0,.1);border:1px solid var(--gold);
            border-radius:7px;padding:8px 14px;font-size:9px;color:var(--gold);display:none;
            font-family:'Share Tech Mono',monospace;max-width:340px;}
        .game-over-buttons{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
        .restart-btn{padding:10px 20px;background:rgba(107,74,255,.2);border:1px solid var(--purple);
            border-radius:7px;color:var(--purple);font-family:'Orbitron',sans-serif;font-size:9px;
            font-weight:700;cursor:pointer;letter-spacing:1px;transition:all .3s;}
        .restart-btn:hover{background:rgba(107,74,255,.4);}
        .submit-score-btn{padding:10px 20px;background:linear-gradient(135deg,var(--green),#00aa55);
            border:none;border-radius:7px;color:#000;font-family:'Orbitron',sans-serif;font-size:9px;
            font-weight:900;cursor:pointer;letter-spacing:1px;transition:all .3s;}
        .submit-score-btn:hover{transform:translateY(-2px);}
        .submit-score-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
        .prestige-action-btn{padding:10px 20px;background:linear-gradient(135deg,#7a6000,var(--gold));
            border:none;border-radius:7px;color:#000;font-family:'Orbitron',sans-serif;font-size:9px;
            font-weight:900;cursor:pointer;letter-spacing:1px;transition:all .3s;display:none;}

        /* LEVEL COMPLETE */
        .lc-badge{font-size:9px;font-weight:700;letter-spacing:2px;padding:3px 12px;border-radius:20px;text-transform:uppercase;}
        .lc-badge.green{color:var(--green);border:1px solid var(--green);background:rgba(0,255,136,.1);}
        .lc-badge.gold{color:var(--gold);border:1px solid var(--gold);background:rgba(255,215,0,.1);}
        .lc-badge.purple{color:var(--purple);border:1px solid var(--purple);background:rgba(107,74,255,.1);}
        .lc-badge.red{color:var(--red);border:1px solid var(--red);background:rgba(255,68,102,.1);}
        .lc-title{font-size:clamp(16px,4vw,24px);font-weight:900;letter-spacing:2px;
            background:linear-gradient(135deg,var(--cyan),var(--purple));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .lc-subtitle{font-size:8px;color:#666;letter-spacing:1px;font-family:'Share Tech Mono',monospace;}
        .lc-lesson-box{background:rgba(0,212,255,.06);border:1px solid rgba(0,212,255,.25);
            border-radius:10px;padding:12px 14px;max-width:400px;width:100%;text-align:left;}
        .lc-lesson-title{font-size:9px;color:var(--cyan);font-weight:700;letter-spacing:1px;margin-bottom:6px;text-transform:uppercase;}
        .lc-lesson-text{font-size:9px;color:#888;font-family:'Share Tech Mono',monospace;line-height:1.8;}
        .lc-lesson-text span{color:var(--cyan);}.lc-lesson-text strong{color:var(--gold);}
        .lc-next-box{background:rgba(107,74,255,.08);border:1px solid rgba(107,74,255,.3);
            border-radius:10px;padding:10px 14px;max-width:400px;width:100%;text-align:left;}
        .lc-next-title{font-size:9px;color:var(--purple);font-weight:700;letter-spacing:1px;margin-bottom:6px;text-transform:uppercase;}
        .lc-next-stats{display:flex;gap:14px;flex-wrap:wrap;}
        .lc-stat{font-size:8px;font-family:'Share Tech Mono',monospace;}
        .lc-stat .stat-label{color:#555;margin-bottom:1px;}.lc-stat .stat-val{color:var(--purple);font-weight:700;font-size:12px;}
        .lc-continue-btn{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;padding:12px 36px;
            background:linear-gradient(135deg,var(--purple),var(--cyan));border:none;border-radius:8px;
            color:#fff;cursor:pointer;text-transform:uppercase;letter-spacing:2px;
            box-shadow:0 6px 25px rgba(107,74,255,.5);animation:bounce 1.2s ease-in-out infinite;}
        .lc-continue-btn:hover{animation:none;transform:translateY(-2px);}

        /* COUNTDOWN */
        .countdown-num{font-size:clamp(60px,20vw,120px);font-weight:900;font-family:'Orbitron',sans-serif;
            background:linear-gradient(135deg,var(--cyan),var(--purple));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            animation:countPop .9s ease-out;line-height:1;}
        .countdown-num.go{font-size:clamp(40px,12vw,72px);background:linear-gradient(135deg,var(--green),var(--cyan));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .countdown-sub{font-size:10px;color:#555;letter-spacing:2px;font-family:'Share Tech Mono',monospace;}
        @keyframes countPop{0%{transform:scale(2.5);opacity:0}40%{transform:scale(.9);opacity:1}100%{transform:scale(1)}}

        /* FOOTER */
        .stellar-footer{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);
            font-size:8px;color:#333;display:flex;align-items:center;gap:6px;z-index:10;
            font-family:'Share Tech Mono',monospace;pointer-events:none;}
        .stellar-footer-logo{width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--cyan),var(--purple));}
    </style>
</head>
<body>

<div class="menu-toggle" id="menuToggle"><span></span><span></span><span></span></div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="main-container">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div style="height: 40px;"></div>

        <!-- Wallet -->
        <div class="wallet-section">
            <div class="wallet-header">
                <div class="stellar-logo">S</div>
                <div class="wallet-title">Stellar Wallet</div>
            </div>
            <div class="wallet-status" id="walletStatus">Not Connected</div>
            <button class="connect-wallet-btn" id="connectWalletBtn">Connect Wallet</button>
        </div>

        <!-- Prestige -->
        <div class="prestige-section">
            <div class="prestige-title">‚ö° Validator Prestige</div>
            <div class="prestige-info" id="prestigeInfo">
                Level: <span id="prestigeLevel">0</span> &nbsp;¬∑&nbsp;
                Mult: <span id="prestigeMult">1.0x</span><br>
                Fees: <span id="totalFees">0</span> / 5000
            </div>
            <button class="prestige-btn" id="prestigeBtn">BECOME VALIDATOR</button>
        </div>

        <!-- Upgrade Shop -->
        <div class="shop-section">
            <div class="shop-title">üîß Tx Upgrades</div>
            <div id="upgradeList"></div>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard-section">
            <div class="leaderboard-header">
                <div class="leaderboard-title">üèÜ Validators</div>
                <div class="zk-badge">ZK Verified</div>
            </div>
            <div class="leaderboard-list" id="leaderboardList">
                <div class="empty-leaderboard">No validators yet.<br>Be the first!</div>
            </div>
        </div>
    </div>

    <!-- GAME -->
    <div class="game-container">
        <!-- HUD -->
        <div class="game-hud">
            <div class="hud-item">
                <div class="hud-label">Fees Collected</div>
                <div class="hud-value fees" id="score">0</div>
            </div>
            <div class="hud-item">
                <div class="hud-label">Level</div>
                <div class="hud-value" id="levelDisplay" style="color:var(--purple)">S1-L1</div>
            </div>
            <div class="hud-item">
                <div class="hud-label">Priority</div>
                <div class="hud-value priority" id="speed">1.00x</div>
            </div>
            <div class="hud-item">
                <div class="hud-label">Prestige</div>
                <div class="hud-value" id="hudPrestige" style="color:var(--gold)">Lv.0</div>
            </div>
        </div>
        <!-- Fee progress bar -->
        <div id="feeProgressBar" style="width:600px;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;margin-bottom:4px;overflow:hidden;display:none;">
            <div id="feeProgressFill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--purple),var(--cyan));transition:width 0.3s;border-radius:3px;"></div>
        </div>
        <div id="feeProgressLabel" style="width:600px;font-size:9px;color:#555;text-align:center;font-family:'Share Tech Mono',monospace;margin-bottom:4px;display:none;">
            FEE PROGRESS: 0 / 300 ¬∑ OBSTACLE DAMAGE: 15%
        </div>

        <!-- ZK Live Recording Bar -->
        <div class="zk-live-bar" id="zkLiveBar">
            <div class="zk-dot"></div>
            <span class="zk-live-text">üîê ZK Recording ‚Äî actions being committed to proof</span>
            <span class="zk-live-actions" id="zkActionCount">0 ticks</span>
            <span class="zk-live-seed" id="zkSeedDisplay">seed: ‚Äî</span>
        </div>

        <!-- Tooltip -->
        <div class="tooltip" id="tooltip"></div>

        <div class="canvas-scale-wrapper">
            <!-- Canvas -->
            <canvas id="gameCanvas" width="600" height="600"></canvas>

            <!-- Countdown Overlay -->
            <div class="countdown-overlay" id="countdownOverlay">
                <div class="countdown-num" id="countdownNum">3</div>
                <div class="countdown-sub" id="countdownSub">MEMPOOL ENTRY IN...</div>
            </div>

            <!-- Start Screen -->
            <div class="start-screen" id="startScreen">
                <div class="game-title">CHAIN SPEEDWAY</div>
                <div class="game-subtitle">ZK Transaction Racing on Stellar</div>

                <div class="narrative-box">
                    <div class="narrative-title">üì° You Are a Stellar TX</div>
                    <div class="narrative-text">
                        Race through the <span>mempool</span>. Collect <span>fee gems</span>.<br>
                        Dodge threats ‚Äî each one teaches real blockchain concepts.<br>
                        Reach block confirmation. Submit your <span>ZK proof</span>.
                    </div>
                </div>

                <div class="lane-info">
                    <div class="lane-tag lane-slow">Slow</div>
                    <div class="lane-tag lane-med">Medium</div>
                    <div class="lane-tag lane-fast">Fast</div>
                </div>

                <div class="start-instructions">
                    ‚Üê ‚Üí to switch lanes &nbsp;¬∑&nbsp; üíé Collect gems &nbsp;¬∑&nbsp; ‚õî Dodge threats
                </div>
                <button class="start-btn" id="startBtn">BROADCAST TX</button>
            </div>

            <!-- Level Complete Interstitial -->
            <div class="level-complete-screen" id="levelCompleteScreen">
                <div class="lc-badge green" id="lcBadge">LEVEL COMPLETE</div>
                <div class="lc-title" id="lcTitle">BLOCK CONFIRMED</div>
                <div class="lc-subtitle" id="lcSubtitle">Transaction validated successfully</div>

                <div class="lc-lesson-box">
                    <div class="lc-lesson-title" id="lcLessonTitle">üì° What You Just Learned</div>
                    <div class="lc-lesson-text" id="lcLessonText">Lesson text goes here.</div>
                </div>

                <div class="lc-next-box">
                    <div class="lc-next-title" id="lcNextTitle">‚ñ∂ NEXT: What's Ahead</div>
                    <div class="lc-next-stats" id="lcNextStats"></div>
                </div>

                <button class="lc-continue-btn" id="lcContinueBtn">CONTINUE ‚Üí</button>
            </div>

            <!-- Game Over -->
            <div class="game-over-screen" id="gameOverScreen">
                <div class="game-over-title">TX REJECTED</div>
                <div class="block-result" id="blockResult">Transaction failed to reach confirmation</div>

                <div class="score-breakdown">
                    <div class="score-row"><span class="label">Blocks Confirmed</span><span class="val" id="finalBlocks">0</span></div>
                    <div class="score-row"><span class="label">Threats Dodged</span><span class="val" id="finalDodged">0</span></div>
                    <div class="score-row"><span class="label">Prestige Multiplier</span><span class="val" id="finalMult">1.0x</span></div>
                    <div class="score-row" id="finalZKRow" style="border-top:1px solid rgba(0,255,136,.15);margin-top:4px;padding-top:4px;">
                        <span class="label" style="color:var(--green)">üîê ZK Proof</span>
                        <span class="val" style="color:var(--green);font-size:8px;">Ready</span>
                    </div>
                    <div class="score-row total"><span class="label">Total Fees</span><span class="val" id="finalScore">0</span></div>
                </div>

                <div class="prestige-available-banner" id="prestigeBanner">
                    ‚ö° Enough fees to Prestige! Become a Validator ‚Üí
                </div>

                <div class="zk-proof-status" id="zkProofStatus">Generating ZK Proof...</div>

                <div class="game-over-buttons">
                    <button class="restart-btn" id="restartBtn">RETRY TX</button>
                    <button class="submit-score-btn" id="submitScoreBtn">SUBMIT TO LEDGER</button>
                    <button class="prestige-action-btn" id="prestigeActionBtn">‚ö° PRESTIGE</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="stellar-footer">
    <div class="stellar-footer-logo"></div>
    <span>Stellar Chain Speedway ¬∑ Protocol 25</span>
</div>

<script>
// ============================================================
// STELLAR CONFIG
// ============================================================
const CONTRACT_ID = 'CA7DLSPSWKZSU425D3W5TXTPS4GQMTX5T2AFUI6TREJZWML5MIKRC54S';
const GAME_HUB   = 'CB4VZAT2U3UC6XFK3N23SKRF2NDCMP3QHJYMCHHFMZO7MRQO6DQ2EMYG';
const RPC_URL    = 'https://soroban-testnet.stellar.org';
const NET_PASS   = 'Test SDF Network ; September 2015';
const PROVER_URL = 'http://localhost:3002/prove';
let sessionId    = null;

// ============================================================
// SIDEBAR
// ============================================================
const menuToggle     = document.getElementById('menuToggle');
const sidebar        = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');

function toggleSidebar() {
    sidebar.classList.toggle('open');
    sidebarOverlay.classList.toggle('active');
    menuToggle.classList.toggle('active');
}
menuToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(); });
sidebarOverlay.addEventListener('click', toggleSidebar);
sidebar.addEventListener('click', (e) => e.stopPropagation());
document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && sidebar.classList.contains('open')) toggleSidebar();
});

// ============================================================
// WALLET
// ============================================================
let walletState = { connected: false, address: null, keypair: null };

const connectWalletBtn = document.getElementById('connectWalletBtn');
const walletStatus     = document.getElementById('walletStatus');

async function connectWallet() {
    try {
        connectWalletBtn.textContent = 'Connecting...';
        connectWalletBtn.disabled = true;

        if (typeof window.freighterApi !== 'undefined') {
            const allowed = await window.freighterApi.isConnected();
            if (allowed) {
                const pk = await window.freighterApi.getPublicKey();
                walletState.connected = true;
                walletState.address = pk;
                updateWalletUI();
                return;
            }
        }

        // Demo keypair ‚Äî fund via friendbot
        const kp = StellarSdk.Keypair.random();
        walletStatus.textContent = 'Funding testnet account...';
        await fetch(`https://friendbot.stellar.org?addr=${kp.publicKey()}`);
        walletState = { connected: true, address: kp.publicKey(), keypair: kp };
        updateWalletUI();
        fetchLeaderboard();
    } catch (e) {
        console.error(e);
        connectWalletBtn.textContent = 'Connect Wallet';
        connectWalletBtn.disabled = false;
    }
}

function updateWalletUI() {
    walletStatus.classList.add('connected');
    walletStatus.textContent = `‚úì ${walletState.address.slice(0,8)}...${walletState.address.slice(-4)}`;
    connectWalletBtn.textContent = '‚úï Disconnect';
    connectWalletBtn.style.background = 'linear-gradient(135deg,#3a1a1a,#5a2a2a)';
    connectWalletBtn.disabled = false;
}

function disconnectWallet() {
    walletState = { connected: false, address: null, keypair: null };
    walletStatus.classList.remove('connected');
    walletStatus.textContent = 'Not Connected';
    connectWalletBtn.textContent = 'Connect Wallet';
    connectWalletBtn.style.background = 'linear-gradient(135deg,var(--purple),var(--cyan))';
}

function shortenAddress(a) { return a ? `${a.slice(0,6)}...${a.slice(-4)}` : ''; }

connectWalletBtn.addEventListener('click', () => {
    if (walletState.connected) disconnectWallet();
    else connectWallet();
});

// ============================================================
// PRESTIGE SYSTEM
// ============================================================
let prestigeData = {
    level: 0,
    multiplier: 1.0,
    totalFeesEarned: 0,
    prestigeThreshold: 5000
};

function updatePrestigeUI() {
    document.getElementById('prestigeLevel').textContent = prestigeData.level;
    document.getElementById('prestigeMult').textContent  = prestigeData.multiplier.toFixed(1) + 'x';
    document.getElementById('totalFees').textContent     = Math.floor(prestigeData.totalFeesEarned);
    document.getElementById('hudPrestige').textContent   = 'Lv.' + prestigeData.level;

    const btn = document.getElementById('prestigeBtn');
    if (prestigeData.totalFeesEarned >= prestigeData.prestigeThreshold) {
        btn.classList.add('available');
    } else {
        btn.classList.remove('available');
    }
}

function doPrestige() {
    if (prestigeData.totalFeesEarned < prestigeData.prestigeThreshold) return;
    prestigeData.level++;
    prestigeData.multiplier = parseFloat((1.0 + prestigeData.level * 0.25).toFixed(2));
    prestigeData.totalFeesEarned = 0;
    prestigeData.prestigeThreshold = Math.floor(5000 * Math.pow(1.5, prestigeData.level));

    // Reset upgrades
    upgrades.forEach(u => { u.level = 0; });
    renderUpgrades();
    updatePrestigeUI();
    showTooltip(`‚ö° PRESTIGE! You are now a Validator Lv.${prestigeData.level}! Permanent ${prestigeData.multiplier}x multiplier applied.`, 'reward', 4000);
    document.getElementById('prestigeActionBtn').style.display = 'none';
    document.getElementById('prestigeBanner').style.display = 'none';
}

document.getElementById('prestigeBtn').addEventListener('click', doPrestige);
document.getElementById('prestigeActionBtn').addEventListener('click', doPrestige);

// ============================================================
// UPGRADE SHOP
// ============================================================
const upgrades = [
    { id: 'sig',     name: 'Ed25519 Optimizer',  desc: '+dodge speed',       cost: 50,  maxLevel: 3, level: 0, effect: 'dodge' },
    { id: 'fee',     name: 'Fee Buffer',          desc: 'survive 1 hit',      cost: 120, maxLevel: 1, level: 0, effect: 'shield' },
    { id: 'zk',      name: 'ZK Proof Booster',   desc: '+10% fee gems',      cost: 200, maxLevel: 3, level: 0, effect: 'gems' },
    { id: 'memo',    name: 'Memo Field',          desc: '+5 pts per block',   cost: 300, maxLevel: 2, level: 0, effect: 'bonus' },
    { id: 'soroban', name: 'Soroban Gas Opt.',    desc: 'fewer obstacles',    cost: 500, maxLevel: 2, level: 0, effect: 'obstacles' },
];

let shopFees = 0; // fees available to spend in shop

function renderUpgrades() {
    const list = document.getElementById('upgradeList');
    list.innerHTML = upgrades.map(u => `
        <div class="upgrade-item ${u.level >= u.maxLevel ? 'maxed' : u.level > 0 ? 'owned' : ''}"
             onclick="buyUpgrade('${u.id}')" id="upg-${u.id}">
            <div>
                <div class="upgrade-name">${u.name}</div>
                <div class="upgrade-desc">${u.desc}</div>
            </div>
            <div style="text-align:right">
                <div class="upgrade-cost">${u.level >= u.maxLevel ? 'MAX' : u.cost + ' fee'}</div>
                <div class="upgrade-level">${u.level}/${u.maxLevel}</div>
            </div>
        </div>
    `).join('');
}

function buyUpgrade(id) {
    const u = upgrades.find(x => x.id === id);
    if (!u || u.level >= u.maxLevel) return;
    if (shopFees < u.cost) {
        showTooltip(`Need ${u.cost} fees to buy ${u.name}`, 'warning', 2000);
        return;
    }
    shopFees -= u.cost;
    u.level++;
    u.cost = Math.floor(u.cost * 1.8);
    renderUpgrades();
    showTooltip(`‚úì ${u.name} upgraded to Lv.${u.level}!`, 'reward', 2000);
    applyUpgradeEffects();
}

function applyUpgradeEffects() {
    // dodge speed
    const sigUpg = upgrades.find(x => x.id === 'sig');
    player.moveSpeed = 8 + sigUpg.level * 3;
    // obstacle reduction handled in spawnObstacle
}

renderUpgrades();

// ============================================================
// TOOLTIP
// ============================================================
let tooltipTimer = null;
function showTooltip(msg, type = '', duration = 2500) {
    const t = document.getElementById('tooltip');
    t.textContent = msg;
    t.className = 'tooltip show' + (type ? ' ' + type : '');
    clearTimeout(tooltipTimer);
    tooltipTimer = setTimeout(() => t.classList.remove('show'), duration);
}

// ============================================================
// BLOCKCHAIN TOOLTIPS ‚Äî educational
// ============================================================
const blockchainTips = {
    doublespend: '‚ö†Ô∏è Double-Spend Attack: A malicious actor tried to spend the same XLM twice. Stellar validators reject this instantly.',
    congestion:  'üåê Network Congestion: Too many transactions competing for block space. Higher fees get priority!',
    invalidsig:  'üîë Invalid Signature: Transaction rejected ‚Äî cryptographic signature didn\'t match. Ed25519 protects the network.',
    mevbot:      'ü§ñ MEV Bot: Maximal Extractable Value bot front-ran your transaction to steal fees!',
    feegem:      'üíé Fee Gem: Transaction fee collected! Fees incentivize Stellar validators to include your transaction.',
    zkboost:     '‚ö° ZK Boost: Protocol 25 ZK operation activated ‚Äî your transaction gets priority processing!',
    speedup:     'üì¶ Block confirmed! 15 blocks processed. Network throughput increasing...',
};

let tipCooldown = {};
function showBlockchainTip(key) {
    if (tipCooldown[key]) return;
    tipCooldown[key] = true;
    showTooltip(blockchainTips[key], key === 'feegem' ? 'reward' : key === 'zkboost' ? 'reward' : 'warning', 3000);
    setTimeout(() => { tipCooldown[key] = false; }, 8000);
}

// ============================================================
// STELLAR CONTRACT
// ============================================================
async function callContract(method, args) {
    if (!walletState.keypair) throw new Error('No keypair');
    const server  = new StellarSdk.SorobanRpc.Server(RPC_URL);
    const account = await server.getAccount(walletState.address);
    const contract = new StellarSdk.Contract(CONTRACT_ID);
    const tx = new StellarSdk.TransactionBuilder(account, {
        fee: StellarSdk.BASE_FEE,
        networkPassphrase: NET_PASS,
    }).addOperation(contract.call(method, ...args)).setTimeout(30).build();
    const prepared = await server.prepareTransaction(tx);
    prepared.sign(walletState.keypair);
    return await server.sendTransaction(prepared);
}

async function startGameOnChain() {
    if (!walletState.connected || !walletState.keypair) return;
    try {
        sessionId = (() => { const b = new Uint32Array(1); crypto.getRandomValues(b); return b[0] || 1; })();
        await callContract('start_game', [
            StellarSdk.nativeToScVal(sessionId, { type: 'u32' }),
            StellarSdk.Address.fromString(walletState.address).toScVal(),
        ]);
        showTooltip('üì° Transaction broadcast to mempool! Session #' + sessionId, 'reward', 3000);
    } catch (e) { console.error('start_game:', e); }
}

async function generateZKProof(score) {
    try {
        const payload = {
            seed: gameState.seed,
            actions: gameState.actions,
            player_address: walletState.address || 'DEMO',
            game_id: gameState.gameId,
        };
        const res = await fetch(PROVER_URL, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(res.status);
        return await res.json();
    } catch (e) {
        console.warn('Prover unavailable, mock proof:', e.message);
        // Return mock proof with correct structure for demo
        return {
            seal: '00'.repeat(64),
            journal: '00'.repeat(32),
            score_verified: score,
            game_id: gameState.gameId,
        };
    }
}

async function submitScore(score) {
    if (!walletState.connected) { alert('Connect wallet first!'); return; }

    const zkStatus  = document.getElementById('zkProofStatus');
    const submitBtn = document.getElementById('submitScoreBtn');

    try {
        zkStatus.style.display = 'block';
        zkStatus.classList.add('generating');
        zkStatus.textContent = 'üîê Generating ZK Proof of transaction validity...';
        submitBtn.disabled = true;

        const proof = await generateZKProof(score);
        zkStatus.textContent = '‚úì ZK Proof generated! Broadcasting to Stellar...';

        if (!sessionId) await startGameOnChain();

        if (walletState.keypair && sessionId) {
            const hexToBytes = h => new Uint8Array(h.match(/.{1,2}/g).map(b => parseInt(b, 16)));
            const proofVal = StellarSdk.xdr.ScVal.scvMap([
                new StellarSdk.xdr.ScMapEntry({
                    key: StellarSdk.xdr.ScVal.scvSymbol('seal'),
                    val: StellarSdk.xdr.ScVal.scvBytes(hexToBytes(proof.seal))
                }),
                new StellarSdk.xdr.ScMapEntry({
                    key: StellarSdk.xdr.ScVal.scvSymbol('journal'),
                    val: StellarSdk.xdr.ScVal.scvBytes(hexToBytes(proof.journal))
                })
            ]);
            await callContract('submit_score', [
                StellarSdk.nativeToScVal(sessionId, { type: 'u32' }),
                StellarSdk.Address.fromString(walletState.address).toScVal(),
                StellarSdk.nativeToScVal(score, { type: 'u32' }),
                proofVal
            ]);
            sessionId = null;
            await fetchLeaderboard();
        } else {
            // Fallback local leaderboard
            addToLocalLeaderboard(score);
        }

        // Add to total fees for prestige
        prestigeData.totalFeesEarned += score * prestigeData.multiplier;
        updatePrestigeUI();

        // Add to shop fees
        shopFees += Math.floor(score * 0.2);
        renderUpgrades();

        zkStatus.classList.remove('generating');
        zkStatus.textContent = '‚úì Score confirmed on Stellar ledger! ZK proof verified.';
        setTimeout(() => { zkStatus.style.display = 'none'; submitBtn.disabled = false; }, 3000);

    } catch (e) {
        console.error(e);
        zkStatus.classList.remove('generating');
        zkStatus.textContent = '‚úó Submission failed: ' + e.message;
        submitBtn.disabled = false;
    }
}

// ============================================================
// LEADERBOARD
// ============================================================
let leaderboard = [];

function addToLocalLeaderboard(score) {
    leaderboard.push({
        rank: 0,
        address: shortenAddress(walletState.address || 'DEMO'),
        score: Math.floor(score * prestigeData.multiplier),
        prestige: prestigeData.level
    });
    leaderboard.sort((a, b) => b.score - a.score);
    leaderboard = leaderboard.slice(0, 10);
    leaderboard.forEach((e, i) => e.rank = i + 1);
    renderLeaderboard();
}

async function fetchLeaderboard() {
    try {
        const server = new StellarSdk.SorobanRpc.Server(RPC_URL);
        const contract = new StellarSdk.Contract(CONTRACT_ID);
        const kp = walletState.keypair || StellarSdk.Keypair.random();
        const account = await server.getAccount(kp.publicKey()).catch(() => null);
        if (!account) return;
        const tx = new StellarSdk.TransactionBuilder(account, {
            fee: StellarSdk.BASE_FEE, networkPassphrase: NET_PASS,
        }).addOperation(contract.call('get_leaderboard')).setTimeout(30).build();
        const result = await server.simulateTransaction(tx);
        if (result?.result?.retval) {
            const entries = StellarSdk.scValToNative(result.result.retval);
            leaderboard = entries.map((e, i) => ({
                rank: i + 1, address: shortenAddress(e.player),
                score: Number(e.score), prestige: 0
            }));
            renderLeaderboard();
        }
    } catch (e) { console.warn('Leaderboard fetch:', e.message); }
}

function renderLeaderboard() {
    const list = document.getElementById('leaderboardList');
    if (!leaderboard.length) {
        list.innerHTML = '<div class="empty-leaderboard">No validators yet.<br>Be the first!</div>';
        return;
    }
    list.innerHTML = leaderboard.map((e, i) => {
        const cls = i === 0 ? 'top-1' : i === 1 ? 'top-2' : i === 2 ? 'top-3' : '';
        const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i+1}`;
        return `<div class="leaderboard-entry ${cls}">
            <span class="entry-rank">${medal}</span>
            <span class="entry-address">${e.address}</span>
            <span class="entry-score">${e.score}</span>
            ${e.prestige > 0 ? `<span class="entry-prestige">‚ö°${e.prestige}</span>` : ''}
        </div>`;
    }).join('');
}

renderLeaderboard();
fetchLeaderboard();

// ============================================================
// GAME ENGINE
// ============================================================
const canvas         = document.getElementById('gameCanvas');
const ctx            = canvas.getContext('2d');
const scoreEl        = document.getElementById('score');
const speedEl        = document.getElementById('speed');
const levelDisplayEl = document.getElementById('levelDisplay');
const feeProgressFill = document.getElementById('feeProgressFill');
const feeProgressLabel = document.getElementById('feeProgressLabel');
const feeProgressBar   = document.getElementById('feeProgressBar');
const gameOverScreen = document.getElementById('gameOverScreen');
const startScreen    = document.getElementById('startScreen');
const startBtn       = document.getElementById('startBtn');
const restartBtn     = document.getElementById('restartBtn');
const submitScoreBtn = document.getElementById('submitScoreBtn');

const LANES       = 3;
const LANE_WIDTH  = canvas.width / LANES;
const LANE_POS    = [LANE_WIDTH/2, canvas.width/2, canvas.width - LANE_WIDTH/2];
const LANE_COLORS = ['rgba(0,255,136,0.15)', 'rgba(255,215,0,0.10)', 'rgba(255,68,102,0.10)'];

// Obstacle types
const THREAT_TYPES = [
    { id: 'doublespend', label: '‚õî DBL-SPEND', color: '#ff4466', tip: 'doublespend' },
    { id: 'congestion',  label: 'üåê CONGESTION', color: '#ff8c00', tip: 'congestion' },
    { id: 'invalidsig',  label: 'üîë INV-SIG',    color: '#cc44ff', tip: 'invalidsig' },
    { id: 'mevbot',      label: 'ü§ñ MEV BOT',    color: '#ff0066', tip: 'mevbot' },
];

// ============================================================
// PROGRESSION SYSTEM ‚Äî Sets √ó Levels
// ============================================================
const GAME_SETS = [
    { label: 'SET 1 ‚Äî FEE WARS', obstacleDamage: 0.15, color: '#00ff88', levels: [
        { speed: 1.0, feeTarget: 250,  label: 'S1-L1', name: 'Low Priority' },
        { speed: 1.0, feeTarget: 500,  label: 'S1-L2', name: 'Standard Fee' },
        { speed: 1.0, feeTarget: 800,  label: 'S1-L3', name: 'High Priority' },
    ]},
    { label: 'SET 2 ‚Äî SPEED & FEES', obstacleDamage: 0.30, color: '#ffd700', levels: [
        { speed: 1.6, feeTarget: 450,  label: 'S2-L1', name: 'L2 Entry' },
        { speed: 2.1, feeTarget: 800,  label: 'S2-L2', name: 'Rollup Lane' },
        { speed: 2.7, feeTarget: 1200, label: 'S2-L3', name: 'Bridge Speed' },
    ]},
    { label: 'SET 3 ‚Äî ZK PRESSURE', obstacleDamage: 0.55, color: '#a855f7', levels: [
        { speed: 2.2, feeTarget: 700,  label: 'S3-L1', name: 'Proof Load' },
        { speed: 3.0, feeTarget: 1200, label: 'S3-L2', name: 'Prover Cost' },
        { speed: 3.8, feeTarget: 1800, label: 'S3-L3', name: 'Aggregation' },
    ]},
    { label: 'FINAL ‚Äî VALIDATOR WARS', obstacleDamage: 0.95, color: '#ff4466', levels: [
        { speed: 2.8, feeTarget: 1000, label: 'F-L1', name: 'Consensus' },
        { speed: 3.8, feeTarget: 1800, label: 'F-L2', name: 'Validator Race' },
        { speed: 4.8, feeTarget: 2800, label: 'F-L3', name: 'Ledger Finality' },
    ]},
];

// Educational content for each level-complete transition
// key = "fromSet-fromLevel" (0-indexed)
const LEVEL_LESSONS = {
    '0-0': {
        badge: 'green', title: 'FEE PRIORITY UNLOCKED',
        subtitle: 'S1-L1 Complete ¬∑ Fees Collected',
        lessonTitle: 'üíé Lesson: Transaction Fee Basics',
        lesson: `Stellar transactions pay fees in <span>stroops</span> to get included in a block.\nValidators pick <span>highest-fee transactions first</span> ‚Äî exactly like you just raced.`,
        nextTitle: '‚ñ∂ Next Level',
        nextStats: [
            { label: 'SPEED', val: '1.0x (same)' },
            { label: 'FEE TARGET', val: '500 fees' },
            { label: 'OBSTACLE DMG', val: '15%' },
            { label: 'TIP', val: 'Stay in FAST lane more' },
        ]
    },
    '0-1': {
        badge: 'green', title: 'BLOCK CONFIRMED',
        subtitle: 'S1-L2 Complete ¬∑ Standard Fee Lane Cleared',
        lessonTitle: 'üì¶ Lesson: Fee Markets & Block Space',
        lesson: `When the network is busy, <span>fees surge</span> ‚Äî validators run a fee auction.\nYou've been living inside that auction.`,
        nextTitle: '‚ñ∂ Next Level',
        nextStats: [
            { label: 'SPEED', val: '1.0x' },
            { label: 'FEE TARGET', val: '800 fees' },
            { label: 'OBSTACLE DMG', val: '15%' },
            { label: 'TIP', val: 'Collect ZK gems ‚Äî they\'re worth 5x' },
        ]
    },
    '0-2': {
        badge: 'gold', title: 'SET 1 MASTERED!',
        subtitle: 'Fee Wars Complete ¬∑ Entering Speed Dimension',
        lessonTitle: 'üåê Lesson: L1 vs L2 ‚Äî Why Speed Matters',
        lesson: `<strong>Layer 2 networks</strong> batch transactions off-chain and submit one <span>compressed proof</span> to L1.\nStellar <span>Protocol 25</span> adds ZK infrastructure to make this possible.`,
        nextTitle: '‚ñ∂ Entering Set 2',
        nextStats: [
            { label: 'SPEED', val: '1.6x üî∫' },
            { label: 'FEE TARGET', val: '450 fees' },
            { label: 'OBSTACLE DMG', val: '30% ‚ö†Ô∏è' },
            { label: 'NEW MECHANIC', val: 'Speed now kills too' },
        ]
    },
    '1-0': {
        badge: 'gold', title: 'L2 ENTRY CLEARED',
        subtitle: 'S2-L1 Complete ¬∑ Rollup Lane Open',
        lessonTitle: '‚ö° Lesson: Rollups & Transaction Batching',
        lesson: `<span>ZK rollups</span> prove transaction validity instantly ‚Äî no waiting period.\nStellar's <span>5-second ledger close</span> means ZK proofs settle faster than any EVM chain.`,
        nextTitle: '‚ñ∂ Next Level',
        nextStats: [
            { label: 'SPEED', val: '2.1x üî∫üî∫' },
            { label: 'FEE TARGET', val: '800 fees' },
            { label: 'OBSTACLE DMG', val: '30%' },
            { label: 'TIP', val: 'Use the shield upgrade now' },
        ]
    },
    '1-1': {
        badge: 'gold', title: 'ROLLUP LANE CLEARED',
        subtitle: 'S2-L2 Complete ¬∑ Cross-Chain Bridge Ahead',
        lessonTitle: 'üîó Lesson: Cross-Chain Bridges & Settlement',
        lesson: `Most bridges have <strong>7-day fraud windows</strong>. ZK bridges settle in minutes.\nStellar <span>Soroban</span> + ZK proofs enable atomic cross-chain swaps ‚Äî no waiting.`,
        nextTitle: '‚ñ∂ Next Level',
        nextStats: [
            { label: 'SPEED', val: '2.7x üî∫üî∫üî∫' },
            { label: 'FEE TARGET', val: '1200 fees' },
            { label: 'OBSTACLE DMG', val: '30%' },
            { label: 'TIP', val: 'Dodge first, collect second' },
        ]
    },
    '1-2': {
        badge: 'purple', title: 'SET 2 CONQUERED!',
        subtitle: 'Speed & Fees Mastered ¬∑ ZK Layer Unlocked',
        lessonTitle: 'üîê Lesson: Zero-Knowledge Proofs ‚Äî What Are They?',
        lesson: `A <span>ZK proof</span> proves you know something <strong>without revealing it</strong>.\nThis game uses ZK to verify your score on-chain ‚Äî that's real.`,
        nextTitle: '‚ñ∂ Entering Set 3',
        nextStats: [
            { label: 'SPEED', val: '2.2x (resets)' },
            { label: 'FEE TARGET', val: '700 fees' },
            { label: 'OBSTACLE DMG', val: '55% üíÄ' },
            { label: 'WARNING', val: 'Obstacles now serious' },
        ]
    },
    '2-0': {
        badge: 'purple', title: 'PROOF LOAD SURVIVED',
        subtitle: 'S3-L1 Complete ¬∑ Prover Cost Ahead',
        lessonTitle: '‚öôÔ∏è Lesson: Proof Generation Costs',
        lesson: `Generating a ZK proof takes real compute ‚Äî seconds to minutes.\nL2 operators charge fees because they're <span>paying for proof generation</span>.`,
        nextTitle: '‚ñ∂ Next Level',
        nextStats: [
            { label: 'SPEED', val: '3.0x üî∫' },
            { label: 'FEE TARGET', val: '1200 fees' },
            { label: 'OBSTACLE DMG', val: '55%' },
            { label: 'TIP', val: 'One hit = half your fees gone' },
        ]
    },
    '2-1': {
        badge: 'purple', title: 'PROVER COST CLEARED',
        subtitle: 'S3-L2 Complete ¬∑ Aggregation Layer Ahead',
        lessonTitle: 'üß© Lesson: Proof Aggregation & Recursive ZK',
        lesson: `<span>Recursive ZK</span> lets you prove thousands of transactions in one tiny proof.\n<span>RISC Zero zkVM</span> runs this game's logic and proves it was correct ‚Äî on-chain.`,
        nextTitle: '‚ñ∂ Next Level',
        nextStats: [
            { label: 'SPEED', val: '3.8x üî∫üî∫' },
            { label: 'FEE TARGET', val: '1800 fees' },
            { label: 'OBSTACLE DMG', val: '55%' },
            { label: 'TIP', val: 'ZK gems give speed burst' },
        ]
    },
    '2-2': {
        badge: 'red', title: 'ZK LAYER MASTERED!',
        subtitle: 'The Final Mempool Awaits You',
        lessonTitle: '‚öîÔ∏è Lesson: Validator Economics & MEV',
        lesson: `<span>MEV bots</span> reorder and front-run transactions to steal fees.\n<strong>Encrypted mempools</strong> using ZK proofs make this cryptographically impossible.`,
        nextTitle: '‚ñ∂ Final Set',
        nextStats: [
            { label: 'SPEED', val: '2.8x (resets)' },
            { label: 'FEE TARGET', val: '1000 fees' },
            { label: 'OBSTACLE DMG', val: '95% üíÄüíÄ' },
            { label: 'WARNING', val: 'ONE HIT = near death' },
        ]
    },
    '3-0': {
        badge: 'red', title: 'CONSENSUS SURVIVED',
        subtitle: 'F-L1 Complete ¬∑ Validator Race Begins',
        lessonTitle: 'üèÅ Lesson: Stellar Consensus Protocol (SCP)',
        lesson: `Stellar uses <span>Federated Byzantine Agreement</span> ‚Äî no mining, no staking.\nYour score submission just reached <span>global consensus in ~5 seconds</span>.`,
        nextTitle: '‚ñ∂ NEXT: F-L2 ‚Äî Validator Race',
        nextStats: [
            { label: 'SPEED', val: '3.8x üî∫' },
            { label: 'FEE TARGET', val: '1800 fees' },
            { label: 'OBSTACLE DMG', val: '95%' },
            { label: 'TIP', val: 'Shield upgrade is essential' },
        ]
    },
    '3-1': {
        badge: 'red', title: 'VALIDATOR RACE CLEARED',
        subtitle: 'F-L2 Complete ¬∑ Ledger Finality Remains',
        lessonTitle: 'üîÆ Lesson: ZK on Stellar ‚Äî The Hackathon Vision',
        lesson: `<span>Stellar Protocol 25</span> introduces native ZK tooling via Soroban.\nThis game proves it: your score is <strong>ZK-verified on-chain</strong>.\nImagine: <span>private DeFi</span>, <span>verifiable gaming</span>, <span>ZK identity</span>,\nall on Stellar's <strong>5-second finality + $0.00001 fees</strong>.\nThis is what you're building. This is the frontier.`,
        nextTitle: '‚ñ∂ FINAL: F-L3 ‚Äî Ledger Finality',
        nextStats: [
            { label: 'SPEED', val: '4.8x ‚ö°' },
            { label: 'FEE TARGET', val: '2800 fees' },
            { label: 'OBSTACLE DMG', val: '95%' },
            { label: 'WARNING', val: 'The hardest run. Good luck.' },
        ]
    },
};

function getCurrentLevelData() {
    const s = GAME_SETS[gameState.currentSet];
    return s ? s.levels[gameState.currentLevel] : null;
}

function updateLevelHUD() {
    const lv = getCurrentLevelData();
    if (!lv) return;
    levelDisplayEl.textContent = lv.label;
    const pct = Math.min(100, Math.round((gameState.levelFeesCollected / lv.feeTarget) * 100));
    feeProgressFill.style.width = pct + '%';
    const dmg = Math.round(GAME_SETS[gameState.currentSet].obstacleDamage * 100);
    feeProgressLabel.textContent = `FEE PROGRESS: ${Math.floor(gameState.levelFeesCollected)} / ${lv.feeTarget} ¬∑ OBSTACLE DMG: ${dmg}%`;

    // Pulse bar color red at high damage sets
    const col = GAME_SETS[gameState.currentSet].color;
    feeProgressFill.style.background = `linear-gradient(90deg, ${col}88, ${col})`;

    // Canvas danger glow when fees low
    if (gameState.score < 50 && gameState.score > 0) {
        canvas.classList.add('danger');
    } else {
        canvas.classList.remove('danger');
    }
}

// Show the level complete interstitial
function showLevelComplete(fromSet, fromLevel, callback) {
    gameState.isRunning = false;
    if (gameState.animationId) { cancelAnimationFrame(gameState.animationId); gameState.animationId = null; }

    const key = `${fromSet}-${fromLevel}`;
    const data = LEVEL_LESSONS[key] || {
        badge: 'green', title: 'LEVEL COMPLETE',
        subtitle: 'Keep going!',
        lessonTitle: 'üì° Blockchain Tip',
        lesson: 'Every level brings you closer to becoming a full Stellar Validator.',
        nextTitle: '‚ñ∂ NEXT LEVEL',
        nextStats: [{ label: 'KEEP GOING', val: 'üöÄ' }]
    };

    const lcScreen = document.getElementById('levelCompleteScreen');
    document.getElementById('lcBadge').textContent = data.badge === 'red' ? '‚ö†Ô∏è SET COMPLETE' : '‚úì LEVEL COMPLETE';
    document.getElementById('lcBadge').className = `lc-badge ${data.badge}`;
    document.getElementById('lcTitle').textContent = data.title;
    document.getElementById('lcSubtitle').textContent = data.subtitle;
    document.getElementById('lcLessonTitle').textContent = data.lessonTitle;
    document.getElementById('lcLessonText').innerHTML = data.lesson.replace(/\n/g, '<br>');
    document.getElementById('lcNextTitle').textContent = data.nextTitle;
    document.getElementById('lcNextStats').innerHTML = data.nextStats.map(s =>
        `<div class="lc-stat"><div class="stat-label">${s.label}</div><div class="stat-val">${s.val}</div></div>`
    ).join('');

    lcScreen.classList.add('active');

    // Wire continue button
    const btn = document.getElementById('lcContinueBtn');
    const handler = () => {
        btn.removeEventListener('click', handler);
        lcScreen.classList.remove('active');
        callback();
    };
    btn.addEventListener('click', handler);
}

function advanceLevel() {
    const fromSet = gameState.currentSet;
    const fromLevel = gameState.currentLevel;
    const setData = GAME_SETS[gameState.currentSet];
    const nextLevel = gameState.currentLevel + 1;

    let willAdvanceSet = false;
    let isGameWon = false;

    if (nextLevel < setData.levels.length) {
        // Same set, next level
    } else if (gameState.currentSet + 1 < GAME_SETS.length) {
        willAdvanceSet = true;
    } else {
        isGameWon = true;
    }

    showLevelComplete(fromSet, fromLevel, () => {
        if (isGameWon) {
            showTooltip('üèÜ LEGENDARY VALIDATOR! You conquered the full mempool!', 'reward', 6000);
            setTimeout(gameOver, 6000);
            return;
        }

        if (willAdvanceSet) {
            gameState.currentSet++;
            gameState.currentLevel = 0;
        } else {
            gameState.currentLevel = nextLevel;
        }

        gameState.levelFeesCollected = 0;
        const lv = getCurrentLevelData();
        gameState.speed = lv.speed;
        gameState.obstacleDamage = GAME_SETS[gameState.currentSet].obstacleDamage;
        speedEl.textContent = gameState.speed.toFixed(2) + 'x';
        updateLevelHUD();

        // Countdown then resume
        runCountdown(`ENTERING ${lv.label} ‚Äî ${lv.name}`, () => {
            gameState.isRunning = true;
            gameLoop();
        });
    });
}

// ============================================================
// FLOATING SCORE TEXTS
// ============================================================
function spawnFloatingText(x, y, text, color) {
    gameState.floatingTexts.push({
        x, y, text, color,
        opacity: 1.0, vy: -2.5,
        life: 60 // frames
    });
}

function updateFloatingTexts() {
    gameState.floatingTexts.forEach(ft => {
        ft.y  += ft.vy;
        ft.vy *= 0.93;
        ft.life--;
        ft.opacity = Math.max(0, ft.life / 40);
    });
    gameState.floatingTexts = gameState.floatingTexts.filter(ft => ft.life > 0);
}

function drawFloatingTexts() {
    gameState.floatingTexts.forEach(ft => {
        ctx.save();
        ctx.globalAlpha = ft.opacity;
        ctx.font = 'bold 14px Orbitron, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillStyle = ft.color;
        ctx.shadowColor = ft.color;
        ctx.shadowBlur = 10;
        ctx.fillText(ft.text, ft.x, ft.y);
        ctx.restore();
    });
}

let gameState = {
    isRunning: false, score: 0, obstaclesDodged: 0,
    speed: 1, baseSpeed: 5, playerLane: 1,
    obstacles: [], gems: [], zkBoosts: [], floatingTexts: [],
    roadOffset: 0, animationId: null,
    lastObstacleSpawn: 0, minObstacleGap: 200,
    currentSet: 0, currentLevel: 0,
    levelFeesCollected: 0, obstacleDamage: 0.15,
    blocksConfirmed: 0, hasShield: false,
    // ZK proof recording
    seed: 0, actions: [], pendingAction: 0, gameId: 1
};

const player = {
    width: 50, height: 80,
    y: canvas.height - 180,
    targetX: LANE_POS[1], currentX: LANE_POS[1],
    moveSpeed: 8
};

// Draw player as "transaction packet"
function drawTxPacket(x, y) {
    ctx.save();
    // Glow
    ctx.shadowColor = gameState.hasShield ? '#ffd700' : '#6b4aff';
    ctx.shadowBlur = 20;

    // Body ‚Äî data packet
    const gradient = ctx.createLinearGradient(x-22, y, x+22, y+70);
    gradient.addColorStop(0, '#6b4aff');
    gradient.addColorStop(1, '#00d4ff');
    ctx.fillStyle = gradient;
    ctx.fillRect(x-22, y+10, 44, 60);

    // Top sensor
    ctx.fillStyle = '#00d4ff';
    ctx.fillRect(x-14, y, 28, 14);

    // Data lines
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.fillRect(x-16, y+20, 32, 2);
    ctx.fillRect(x-16, y+28, 24, 2);
    ctx.fillRect(x-16, y+36, 28, 2);
    ctx.fillRect(x-16, y+44, 20, 2);

    // Thrusters
    ctx.fillStyle = '#ff8c00';
    ctx.shadowColor = '#ff8c00';
    ctx.shadowBlur = 12;
    ctx.fillRect(x-18, y+68, 12, 8 + Math.random()*4);
    ctx.fillRect(x+6,  y+68, 12, 8 + Math.random()*4);

    // Shield ring
    if (gameState.hasShield) {
        ctx.strokeStyle = '#ffd700';
        ctx.lineWidth = 3;
        ctx.shadowColor = '#ffd700';
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.ellipse(x, y+40, 35, 50, 0, 0, Math.PI*2);
        ctx.stroke();
    }

    ctx.restore();
}

// Draw threat obstacle
function drawThreat(x, y, type) {
    const t = THREAT_TYPES.find(t => t.id === type) || THREAT_TYPES[0];
    ctx.save();
    ctx.shadowColor = t.color; ctx.shadowBlur = 15;

    // Body
    ctx.fillStyle = t.color + '33';
    ctx.strokeStyle = t.color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.roundRect(x-38, y-18, 76, 36, 6);
    ctx.fill(); ctx.stroke();

    // Label
    ctx.fillStyle = t.color;
    ctx.font = 'bold 9px Share Tech Mono, monospace';
    ctx.textAlign = 'center';
    ctx.fillText(t.label, x, y+4);

    ctx.restore();
}

// Draw fee gem
function drawFeeGem(x, y, pulse, isZK) {
    ctx.save();
    const col = isZK ? '#a855f7' : '#ffd700';
    ctx.shadowColor = col; ctx.shadowBlur = 15;
    const s = 14 + Math.sin(pulse) * 2;

    ctx.fillStyle = col;
    ctx.beginPath();
    ctx.moveTo(x, y-s); ctx.lineTo(x+s*0.6, y);
    ctx.lineTo(x, y+s); ctx.lineTo(x-s*0.6, y);
    ctx.closePath(); ctx.fill();

    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.beginPath();
    ctx.moveTo(x, y-s*0.6); ctx.lineTo(x+s*0.3, y-s*0.1);
    ctx.lineTo(x, y+s*0.2); ctx.lineTo(x-s*0.3, y-s*0.1);
    ctx.closePath(); ctx.fill();

    if (isZK) {
        ctx.fillStyle = '#fff'; ctx.font = 'bold 8px monospace'; ctx.textAlign = 'center';
        ctx.fillText('ZK', x, y+3);
    }
    ctx.restore();
}

// Draw mempool road
function drawRoad() {
    // Background
    ctx.fillStyle = '#05050f';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Lane backgrounds
    for (let i = 0; i < LANES; i++) {
        ctx.fillStyle = LANE_COLORS[i];
        ctx.fillRect(LANE_WIDTH * i, 0, LANE_WIDTH, canvas.height);
    }

    // Scrolling data stream particles
    ctx.fillStyle = 'rgba(0,212,255,0.15)';
    for (let i = 0; i < 12; i++) {
        const x = (i * 53 + gameState.roadOffset * 0.5) % canvas.width;
        const y = (i * 83 + gameState.roadOffset * 2) % canvas.height;
        ctx.fillRect(x, y, 2, 8);
    }

    // Lane dividers ‚Äî glowing
    ctx.shadowColor = '#6b4aff'; ctx.shadowBlur = 8;
    ctx.strokeStyle = 'rgba(107,74,255,0.6)';
    ctx.lineWidth = 2;
    ctx.setLineDash([25, 20]);
    ctx.lineDashOffset = -gameState.roadOffset;
    for (let i = 1; i < LANES; i++) {
        ctx.beginPath();
        ctx.moveTo(LANE_WIDTH * i, 0);
        ctx.lineTo(LANE_WIDTH * i, canvas.height);
        ctx.stroke();
    }
    ctx.setLineDash([]);
    ctx.shadowBlur = 0;

    // Lane labels at top
    const laneLabels = ['SLOW FEE', 'MED FEE', 'FAST FEE'];
    const laneClrs   = ['#00ff88', '#ffd700', '#ff4466'];
    for (let i = 0; i < LANES; i++) {
        ctx.fillStyle = laneClrs[i] + '99';
        ctx.font = '8px Orbitron, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(laneLabels[i], LANE_POS[i], 14);
    }

    // Road edges
    ctx.shadowColor = '#00d4ff'; ctx.shadowBlur = 10;
    ctx.strokeStyle = 'rgba(0,212,255,0.4)'; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(2, 0); ctx.lineTo(2, canvas.height); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(canvas.width-2, 0); ctx.lineTo(canvas.width-2, canvas.height); ctx.stroke();
    ctx.shadowBlur = 0;

    // Block confirmation line ‚Äî green line sweeping down
    const lineY = (gameState.roadOffset * 3) % canvas.height;
    ctx.strokeStyle = 'rgba(0,255,136,0.2)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(0, lineY); ctx.lineTo(canvas.width, lineY); ctx.stroke();

    if (gameState.isRunning) {
        gameState.roadOffset += gameState.baseSpeed * gameState.speed;
        if (gameState.roadOffset > 50) gameState.roadOffset = 0;
    }
}

function spawnThreat() {
    const now = Date.now();
    if (now - gameState.lastObstacleSpawn < gameState.minObstacleGap / gameState.speed) return;

    const available = [];
    for (let i = 0; i < LANES; i++) {
        if (!gameState.obstacles.some(o => o.lane === i && o.y > -300)) available.push(i);
    }
    if (available.length === 0) return;

    // Soroban upgrade reduces obstacles
    const soroban = upgrades.find(u => u.id === 'soroban');
    const spawnChance = 0.012 * gameState.speed * (1 - soroban.level * 0.15);
    if (Math.random() > spawnChance * 40) {
        const max = Math.min(available.length - 1, Math.random() > 0.65 ? 2 : 1);
        const shuffled = available.sort(() => Math.random() - 0.5);
        const type = THREAT_TYPES[Math.floor(Math.random() * THREAT_TYPES.length)];
        for (let i = 0; i < max; i++) {
            gameState.obstacles.push({ x: LANE_POS[shuffled[i]], y: -30, lane: shuffled[i], type: type.id, passed: false });
        }
    }
    gameState.lastObstacleSpawn = now;
}

function spawnFeeGem() {
    if (Math.random() < 0.008) {
        const lane = Math.floor(Math.random() * LANES);
        const isZK = Math.random() < 0.15; // 15% ZK boost gem
        gameState.gems.push({ x: LANE_POS[lane], y: -20, lane, pulse: 0, collected: false, isZK });
    }
}

function update() {
    if (!gameState.isRunning) return;

    // ‚îÄ‚îÄ ZK: record this tick's action ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    gameState.actions.push(gameState.pendingAction);
    gameState.pendingAction = 0; // reset for next frame

    // Update ZK live bar every 30 ticks
    if (gameState.actions.length % 30 === 0) {
        document.getElementById('zkActionCount').textContent = gameState.actions.length + ' ticks';
    }

    // Smooth player movement
    const diff = player.targetX - player.currentX;
    if (Math.abs(diff) > 1) player.currentX += diff * 0.25;
    else player.currentX = player.targetX;

    let _unused = false; // no instant death

    // Update threats
    gameState.obstacles.forEach(o => {
        o.y += gameState.baseSpeed * gameState.speed;

        if (!o.passed &&
            o.y + 20 > player.y &&
            o.y - 20 < player.y + player.height &&
            o.lane === gameState.playerLane &&
            Math.abs(player.currentX - o.x) < 45) {

            if (gameState.hasShield) {
                // Shield absorbs hit
                gameState.hasShield = false;
                o.passed = true;
                showTooltip('üõ°Ô∏è Fee Buffer absorbed the attack!', 'reward', 2000);
                spawnFloatingText(player.currentX, player.y - 10, 'BLOCKED!', '#ffd700');
                return;
            }
            // Hit! Reduce fees by damage % 
            const dmgPct = gameState.obstacleDamage;
            const dmgAmt = Math.max(5, Math.floor(gameState.score * dmgPct));
            gameState.score = Math.max(0, gameState.score - dmgAmt);
            gameState.levelFeesCollected = Math.max(0, gameState.levelFeesCollected - dmgAmt);
            scoreEl.textContent = Math.floor(gameState.score);
            o.passed = true;
            spawnFloatingText(player.currentX, player.y - 10, `-${dmgAmt}`, '#ff4466');
            showBlockchainTip(o.type || 'doublespend');
            updateLevelHUD();

            // Death when fees hit zero
            if (gameState.score <= 0 && gameState.isRunning) {
                gameState.score = 0;
                gameState.isRunning = false;
                scoreEl.textContent = '0';
                spawnFloatingText(player.currentX, player.y - 40, 'üíÄ LIQUIDATED', '#ff4466');
                draw();
                setTimeout(gameOver, 900);
                return;
            }
        }

        if (!o.passed && o.y > player.y + player.height) {
            o.passed = true;
            gameState.obstaclesDodged++;
            gameState.blocksConfirmed++;

            // Memo field bonus every 15 blocks
            if (gameState.obstaclesDodged % 15 === 0) {
                showBlockchainTip('speedup');
                const memo = upgrades.find(u => u.id === 'memo');
                const bonus = memo.level * 5;
                if (bonus > 0) {
                    gameState.score += bonus;
                    gameState.levelFeesCollected += bonus;
                    scoreEl.textContent = Math.floor(gameState.score);
                    updateLevelHUD();
                }
            }
        }
    });

    // (no instant death ‚Äî obstacles deal % fee damage)
    gameState.obstacles = gameState.obstacles.filter(o => o.y <= canvas.height + 50);

    // Update fee gems
    gameState.gems.forEach(g => {
        g.y += gameState.baseSpeed * gameState.speed;
        g.pulse += 0.12;

        if (!g.collected &&
            g.y + 20 > player.y && g.y - 20 < player.y + player.height &&
            g.lane === gameState.playerLane &&
            Math.abs(player.currentX - g.x) < 40) {

            g.collected = true;
            const zkUpg = upgrades.find(u => u.id === 'zk');
            const bonus = g.isZK ? 50 : 10;
            const multiplied = Math.floor(bonus * (1 + zkUpg.level * 0.1));
            gameState.score += multiplied;
            gameState.levelFeesCollected += multiplied;
            scoreEl.textContent = Math.floor(gameState.score);
            shopFees += Math.floor(multiplied * 0.3);
            updateLevelHUD();

            // Floating impact text
            const gemColor = g.isZK ? '#a855f7' : '#ffd700';
            const gemLabel = g.isZK ? `+${multiplied} ZK‚ö°` : `+${multiplied}`;
            spawnFloatingText(g.x, g.y, gemLabel, gemColor);

            if (g.isZK) {
                showBlockchainTip('zkboost');
                gameState.speed = Math.min(gameState.speed + 0.15, 5);
                speedEl.textContent = gameState.speed.toFixed(2) + 'x';
            } else {
                showBlockchainTip('feegem');
            }
        }
    });
    gameState.gems = gameState.gems.filter(g => !g.collected && g.y <= canvas.height + 50);

    // Check level advancement
    const lvData = getCurrentLevelData();
    if (lvData && gameState.levelFeesCollected >= lvData.feeTarget) {
        advanceLevel();
    }

    spawnThreat();
    spawnFeeGem();
    updateFloatingTexts();
}

function draw() {
    drawRoad();
    gameState.obstacles.forEach(o => drawThreat(o.x, o.y, o.type));
    gameState.gems.forEach(g => { if (!g.collected) drawFeeGem(g.x, g.y, g.pulse, g.isZK); });
    drawTxPacket(player.currentX, player.y);
    drawFloatingTexts();
}

function gameLoop() {
    update(); draw();
    if (gameState.isRunning) gameState.animationId = requestAnimationFrame(gameLoop);
}

// ============================================================
// COUNTDOWN
// ============================================================
function runCountdown(subText, callback) {
    const overlay = document.getElementById('countdownOverlay');
    const numEl   = document.getElementById('countdownNum');
    const subEl   = document.getElementById('countdownSub');

    overlay.classList.add('active');
    subEl.textContent = subText;

    const steps = ['3', '2', '1', 'GO!'];
    let i = 0;

    function nextStep() {
        if (i >= steps.length) {
            overlay.classList.remove('active');
            callback();
            return;
        }
        numEl.textContent = steps[i];
        numEl.className = 'countdown-num' + (steps[i] === 'GO!' ? ' go' : '');
        // re-trigger animation
        numEl.style.animation = 'none';
        void numEl.offsetHeight;
        numEl.style.animation = '';
        i++;
        setTimeout(nextStep, steps[i - 1] === 'GO!' ? 700 : 900);
    }
    nextStep();
}

function startGame() {
    if (gameState.animationId) { cancelAnimationFrame(gameState.animationId); gameState.animationId = null; }
    startScreen.classList.add('hidden');
    gameOverScreen.classList.remove('active');
    document.getElementById('levelCompleteScreen').classList.remove('active');
    canvas.classList.remove('danger');

    // Generate new ZK seed (BigInt-safe 53-bit random)
    const seed = Math.floor(Math.random() * Number.MAX_SAFE_INTEGER);
    const gid  = Date.now() % 0xFFFFFFFF;

    gameState = {
        isRunning: false, score: 0, obstaclesDodged: 0,
        speed: 1, baseSpeed: 5, playerLane: 1,
        obstacles: [], gems: [], zkBoosts: [], floatingTexts: [],
        roadOffset: 0, animationId: null,
        lastObstacleSpawn: 0, minObstacleGap: 200,
        blocksConfirmed: 0,
        currentSet: 0, currentLevel: 0,
        levelFeesCollected: 0, obstacleDamage: 0.15,
        hasShield: upgrades.find(u => u.id === 'fee').level > 0,
        seed, actions: [], pendingAction: 0, gameId: gid
    };

    player.currentX = LANE_POS[1];
    player.targetX  = LANE_POS[1];
    scoreEl.textContent  = '0';
    speedEl.textContent  = '1.00x';
    feeProgressBar.style.display   = 'block';
    feeProgressLabel.style.display = 'block';

    // Show ZK live bar + seed
    const zkBar = document.getElementById('zkLiveBar');
    zkBar.style.display = 'flex';
    document.getElementById('zkSeedDisplay').textContent = `seed: ${seed.toString(16).slice(0,8)}‚Ä¶`;
    document.getElementById('zkActionCount').textContent = '0 ticks';

    applyUpgradeEffects();
    updateLevelHUD();

    // Render static frame then countdown
    drawRoad();
    drawTxPacket(player.currentX, player.y);

    runCountdown('MEMPOOL ENTRY IN‚Ä¶', () => {
        gameState.isRunning = true;
        gameLoop();
    });
}

function gameOver() {
    gameState.isRunning = false;
    canvas.classList.remove('danger');
    if (gameState.animationId) { cancelAnimationFrame(gameState.animationId); gameState.animationId = null; }

    const finalScore = Math.floor(gameState.score * prestigeData.multiplier);

    document.getElementById('finalBlocks').textContent  = gameState.blocksConfirmed;
    document.getElementById('finalDodged').textContent  = gameState.obstaclesDodged;
    document.getElementById('finalMult').textContent    = prestigeData.multiplier.toFixed(1) + 'x';
    document.getElementById('finalScore').textContent   = finalScore;

    // Show ZK summary row
    const zkRow = document.getElementById('finalZKRow');
    if (zkRow) {
        zkRow.querySelector('.val').textContent =
            `${gameState.actions.length} ticks ¬∑ seed ${gameState.seed.toString(16).slice(0,8)}‚Ä¶`;
    }

    // Check prestige
    const totalAfter = prestigeData.totalFeesEarned + finalScore;
    if (totalAfter >= prestigeData.prestigeThreshold) {
        document.getElementById('prestigeBanner').style.display = 'block';
        document.getElementById('prestigeActionBtn').style.display = 'block';
    }

    submitScoreBtn.disabled = !walletState.connected;
    gameOverScreen.classList.add('active');
}

// ============================================================
// CONTROLS ‚Äî set pendingAction each frame (recorded for ZK proof)
// ============================================================
document.addEventListener('keydown', e => {
    if (!gameState.isRunning) return;
    if (e.key === 'ArrowLeft' && gameState.playerLane > 0) {
        gameState.playerLane--;
        player.targetX = LANE_POS[gameState.playerLane];
        gameState.pendingAction = 1; // left
    } else if (e.key === 'ArrowRight' && gameState.playerLane < LANES-1) {
        gameState.playerLane++;
        player.targetX = LANE_POS[gameState.playerLane];
        gameState.pendingAction = 2; // right
    }
});

// Touch controls
let touchStartX = 0;
canvas.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; });
canvas.addEventListener('touchend', e => {
    const diff = e.changedTouches[0].clientX - touchStartX;
    if (Math.abs(diff) < 30) return;
    if (diff < 0 && gameState.playerLane > 0) {
        gameState.playerLane--; player.targetX = LANE_POS[gameState.playerLane];
        gameState.pendingAction = 1;
    } else if (diff > 0 && gameState.playerLane < LANES-1) {
        gameState.playerLane++; player.targetX = LANE_POS[gameState.playerLane];
        gameState.pendingAction = 2;
    }
});

// ============================================================
// EVENT LISTENERS
// ============================================================
startBtn.addEventListener('click', () => { startGameOnChain(); startGame(); });
restartBtn.addEventListener('click', startGame);
submitScoreBtn.addEventListener('click', () => submitScore(Math.floor(gameState.score * prestigeData.multiplier)));

// Initial render
drawRoad();
drawTxPacket(player.currentX, player.y);
updatePrestigeUI();
</script>
</body>
</html>