<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chainway ‚Äî Stellar ZK Racer</title>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Share+Tech+Mono&family=Teko:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="stellar-sdk.min.js"></script>
    <style>
:root {
    --bg:#050408; --panel:#0a0810; --border:#1c1428; --border2:#2a1e3c;
    --org:#f59e0b; --org-d:#7a4e05; --org-g:rgba(245,158,11,0.10);
    --red:#ef4444; --green:#22c55e; --purple:#8b5cf6;
    --text:#c8a870; --text-dim:#6a5840; --text-faint:#2a1e10;
    --font-g:'Russo One',sans-serif; --font-h:'Teko',sans-serif; --font-m:'Share Tech Mono',monospace;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{height:100%}
body{font-family:var(--font-g);background:var(--bg);color:var(--text);height:100%;display:flex;flex-direction:column;overflow:hidden}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.06) 3px,rgba(0,0,0,0.06) 4px);pointer-events:none;z-index:9999}

/* ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ */
.navbar{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:0 16px;height:52px;background:var(--panel);border-bottom:2px solid var(--org-d);position:relative;z-index:100}
.nav-brand{display:flex;align-items:center;gap:10px;text-decoration:none}
.nav-logo{width:34px;height:34px;background:var(--org);clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);display:flex;align-items:center;justify-content:center;font-family:var(--font-g);font-size:12px;color:var(--bg)}
.nav-title{font-family:var(--font-g);font-size:clamp(14px,2.5vw,20px);color:var(--org);letter-spacing:2px}
.nav-right{display:flex;align-items:center;gap:8px}
.nav-btn{font-family:var(--font-m);font-size:12px;font-weight:700;padding:7px 14px;border:1px solid var(--border2);border-radius:3px;background:transparent;color:var(--text-dim);cursor:pointer;transition:all .2s;text-decoration:none;display:inline-flex;align-items:center;gap:5px;letter-spacing:.5px}
.nav-btn:hover{border-color:var(--org);color:var(--org)}
.nav-btn-wallet{background:var(--org);color:var(--bg);border-color:var(--org);font-weight:700}
.nav-btn-wallet:hover{background:#fbbf24;border-color:#fbbf24;color:var(--bg)}
.nav-btn-wallet.connected{background:transparent;color:var(--green);border-color:var(--green)}

/* ‚îÄ‚îÄ GAME AREA ‚îÄ‚îÄ */
.game-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 12px 6px;gap:6px;overflow:hidden;min-height:0}

/* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
.hud{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:600px;padding:6px 14px;background:var(--panel);border:1px solid var(--border2);border-top:2px solid var(--org-d);border-radius:0 0 4px 4px;flex-shrink:0}
.hud-item{text-align:center}
.hud-label{font-family:var(--font-m);font-size:9px;color:var(--text-faint);letter-spacing:2px;text-transform:uppercase;margin-bottom:1px}
.hud-val{font-family:var(--font-h);font-size:clamp(20px,3.5vw,28px);font-weight:600;line-height:1;color:var(--org)}
.hud-val.level{color:var(--text)}
.hud-val.speed{color:var(--text-dim)}
.hud-pause{background:transparent;border:1px solid var(--border2);border-radius:3px;color:var(--text-dim);font-size:15px;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;font-family:var(--font-m)}
.hud-pause:hover{border-color:var(--org);color:var(--org)}
.hud-pause.hidden{display:none}

/* ‚îÄ‚îÄ FEE BAR ‚îÄ‚îÄ */
.fee-bar-wrap{width:100%;max-width:600px;display:none;flex-shrink:0}
.fee-bar-track{height:5px;background:var(--border);border-radius:2px;overflow:hidden}
.fee-bar-fill{height:100%;width:0%;background:var(--org);border-radius:2px;transition:width .2s}
.fee-bar-label{font-family:var(--font-m);font-size:9px;color:var(--text-dim);text-align:right;margin-top:3px}

/* ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ */
.canvas-wrap{position:relative;width:100%;max-width:600px;flex:1;min-height:0}
canvas{display:block;width:100%;height:100%;border:2px solid var(--border2);border-radius:4px;cursor:crosshair;image-rendering:pixelated}
canvas.danger{border-color:var(--red)!important}
.canvas-wrap::before,.canvas-wrap::after{content:'';position:absolute;width:12px;height:12px;border-color:var(--org);border-style:solid;z-index:5;pointer-events:none}
.canvas-wrap::before{top:-1px;left:-1px;border-width:2px 0 0 2px}
.canvas-wrap::after{bottom:-1px;right:-1px;border-width:0 2px 2px 0}

/* ‚îÄ‚îÄ OVERLAYS ‚îÄ‚îÄ */
.overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:20px;border-radius:4px;text-align:center;overflow-y:auto}
.overlay::-webkit-scrollbar{width:3px}
.overlay::-webkit-scrollbar-thumb{background:var(--border2)}

/* START */
.start-overlay{background:rgba(5,4,8,.97);z-index:50}
.start-overlay.hidden{display:none}
.glitch-title{font-family:var(--font-g);font-size:clamp(26px,7vw,52px);color:var(--org);letter-spacing:4px;line-height:1;animation:glitch 4s infinite}
@keyframes glitch{0%,90%,100%{text-shadow:none;transform:none}92%{text-shadow:2px 0 #ef4444,-2px 0 #3b82f6;transform:translateX(1px)}94%{text-shadow:-2px 0 #ef4444,2px 0 #3b82f6;transform:translateX(-1px)}96%{text-shadow:none;transform:none}}
.title-sub{font-family:var(--font-m);font-size:clamp(9px,1.5vw,12px);color:var(--text-dim);letter-spacing:3px;text-transform:uppercase;border:1px solid var(--border2);padding:4px 14px;border-radius:2px}
.pixel-divider{width:80px;height:2px;background:repeating-linear-gradient(90deg,var(--org) 0px,var(--org) 6px,transparent 6px,transparent 10px)}
.controls-hint{font-family:var(--font-m);font-size:clamp(10px,1.6vw,12px);color:var(--text-faint);letter-spacing:1px;line-height:2}
.controls-hint span{color:var(--text-dim)}
.start-buttons{display:flex;flex-direction:column;gap:10px;width:100%;max-width:260px}
.btn-play{padding:15px 0;font-family:var(--font-g);font-size:clamp(14px,2.2vw,17px);letter-spacing:3px;background:var(--org);color:var(--bg);border:none;border-radius:3px;cursor:pointer;text-transform:uppercase;transition:all .15s;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px))}
.btn-play:hover{background:#fbbf24;transform:translateY(-1px)}
.btn-guest{padding:12px 0;font-family:var(--font-m);font-size:clamp(11px,1.8vw,13px);font-weight:700;background:transparent;color:var(--text-dim);border:1px solid var(--border2);border-radius:3px;cursor:pointer;letter-spacing:1px;transition:all .2s}
.btn-guest:hover{border-color:var(--text-dim);color:var(--text)}
.docs-link-btn{font-family:var(--font-m);font-size:10px;color:var(--text-faint);background:none;border:none;cursor:pointer;letter-spacing:1px;text-decoration:underline;transition:color .2s}
.docs-link-btn:hover{color:var(--text-dim)}

/* DOCS */
.docs-panel{position:absolute;inset:0;background:rgba(5,4,8,.98);border-radius:4px;z-index:65;display:none;flex-direction:column;padding:20px;gap:12px;overflow-y:auto}
.docs-panel.open{display:flex}
.docs-header{display:flex;justify-content:space-between;align-items:center}
.docs-title-txt{font-family:var(--font-g);font-size:18px;color:var(--org);letter-spacing:2px}
.docs-close{background:none;border:1px solid var(--border2);border-radius:3px;color:var(--text-dim);font-size:14px;width:28px;height:28px;cursor:pointer;font-family:var(--font-m);transition:all .2s}
.docs-close:hover{border-color:var(--red);color:var(--red)}
.docs-sec-title{font-family:var(--font-m);font-size:9px;color:var(--org-d);letter-spacing:2px;text-transform:uppercase;margin:8px 0 4px}
.docs-txt{font-family:var(--font-m);font-size:11px;color:var(--text-dim);line-height:1.9}
.docs-txt strong{color:var(--org);font-weight:400}

/* COUNTDOWN */
.countdown-overlay{background:rgba(5,4,8,.9);z-index:70;opacity:0;pointer-events:none;transition:opacity .2s}
.countdown-overlay.active{opacity:1;pointer-events:all}
.countdown-num{font-family:var(--font-g);font-size:clamp(90px,26vw,160px);color:var(--org);line-height:1;animation:cpop .8s ease-out}
.countdown-num.go{color:var(--green);font-size:clamp(50px,16vw,100px)}
@keyframes cpop{0%{transform:scale(2.2);opacity:0}45%{transform:scale(.9);opacity:1}100%{transform:scale(1)}}
.countdown-sub{font-family:var(--font-m);font-size:clamp(10px,1.8vw,13px);color:var(--text-dim);letter-spacing:3px;margin-top:8px}

/* PAUSE */
.pause-overlay{background:rgba(5,4,8,.93);z-index:75;opacity:0;pointer-events:none;transition:opacity .2s}
.pause-overlay.active{opacity:1;pointer-events:all}
.pause-title{font-family:var(--font-g);font-size:clamp(32px,8vw,64px);color:var(--org);letter-spacing:6px}
.pause-sub{font-family:var(--font-m);font-size:clamp(10px,1.6vw,13px);color:var(--text-dim);letter-spacing:2px}
.btn-resume{padding:13px 40px;font-family:var(--font-g);font-size:clamp(13px,2vw,16px);letter-spacing:3px;background:var(--org);color:var(--bg);border:none;border-radius:3px;cursor:pointer;transition:all .2s}
.btn-resume:hover{background:#fbbf24}

/* LEVEL COMPLETE */
.lc-overlay{background:rgba(5,4,8,.97);z-index:60;opacity:0;pointer-events:none;transition:opacity .3s}
.lc-overlay.active{opacity:1;pointer-events:all}
.lc-tag{font-family:var(--font-m);font-size:clamp(10px,1.5vw,12px);letter-spacing:2px;padding:4px 14px;border-radius:2px;text-transform:uppercase}
.lc-tag.orange{color:var(--org);border:1px solid var(--org)}
.lc-tag.green{color:var(--green);border:1px solid var(--green)}
.lc-tag.red{color:var(--red);border:1px solid var(--red)}
.lc-title{font-family:var(--font-g);font-size:clamp(18px,4.5vw,30px);color:var(--text);letter-spacing:2px}
.lc-score-reveal{background:var(--org-g);border:1px solid var(--org-d);border-radius:4px;padding:16px 28px;text-align:center}
.lc-score-label{font-family:var(--font-m);font-size:10px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px}
.lc-score-num{font-family:var(--font-h);font-size:clamp(36px,7vw,56px);color:var(--org);font-weight:600;line-height:1}
.lc-score-sub{font-family:var(--font-m);font-size:9px;color:var(--text-faint);letter-spacing:1px;margin-top:4px}
.lc-lesson{background:var(--panel);border:1px solid var(--border2);border-radius:4px;padding:14px 16px;max-width:420px;width:100%;text-align:left}
.lc-lesson-title{font-family:var(--font-m);font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px}
.lc-lesson-body{font-family:var(--font-m);font-size:clamp(10px,1.7vw,12px);color:var(--text-dim);line-height:1.9}
.lc-lesson-body strong{color:var(--org);font-weight:400}
.btn-continue{padding:13px 36px;font-family:var(--font-g);font-size:clamp(12px,2vw,15px);letter-spacing:2px;background:transparent;color:var(--org);border:1px solid var(--org-d);border-radius:3px;cursor:pointer;text-transform:uppercase;transition:all .2s}
.btn-continue:hover{background:var(--org-g);border-color:var(--org)}

/* GAME OVER */
.go-overlay{background:rgba(5,4,8,.97);z-index:60;opacity:0;pointer-events:none;transition:opacity .3s}
.go-overlay.active{opacity:1;pointer-events:all}
.go-title{font-family:var(--font-g);font-size:clamp(28px,6.5vw,48px);color:var(--red);letter-spacing:5px}
.go-box{background:var(--panel);border:1px solid var(--border2);border-radius:4px;padding:16px 20px;width:100%;max-width:300px}
.go-row{display:flex;justify-content:space-between;font-family:var(--font-m);font-size:clamp(11px,1.8vw,13px);padding:5px 0}
.go-row .lbl{color:var(--text-dim)}.go-row .val{color:var(--org);font-weight:700}
.go-row.total{border-top:1px solid var(--border2);margin-top:8px;padding-top:10px}
.go-row.total .lbl{color:var(--text)}.go-row.total .val{font-family:var(--font-h);font-size:clamp(18px,3vw,24px);color:var(--org)}
.go-note{font-family:var(--font-m);font-size:clamp(9px,1.5vw,11px);color:var(--text-faint);max-width:300px}
.go-note strong{color:var(--green);font-weight:400}
.go-status{font-family:var(--font-m);font-size:11px;color:var(--green);min-height:14px}
.go-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.btn-retry{padding:12px 22px;font-family:var(--font-m);font-size:clamp(11px,1.8vw,13px);font-weight:700;background:transparent;color:var(--text-dim);border:1px solid var(--border2);border-radius:3px;cursor:pointer;transition:all .2s}
.btn-retry:hover{border-color:var(--text-dim);color:var(--text)}
.btn-submit{padding:12px 22px;font-family:var(--font-g);font-size:clamp(12px,1.8vw,14px);letter-spacing:1px;background:var(--green);color:var(--bg);border:none;border-radius:3px;cursor:pointer;transition:all .2s}
.btn-submit:hover{background:#4ade80}.btn-submit:disabled{opacity:.3;cursor:not-allowed}

/* TIP TOAST */
.tip-toast{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(10,8,16,.96);border:1px solid var(--border2);border-radius:3px;padding:8px 16px;font-family:var(--font-m);font-size:clamp(10px,1.7vw,12px);color:var(--text-dim);max-width:94%;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:0;transition:opacity .3s;pointer-events:none;z-index:80}
.tip-toast.show{opacity:1}
.tip-toast.good{color:var(--org);border-color:var(--org-d)}
.tip-toast.bad{color:var(--red);border-color:#7a1010}

/* WALLET MODAL */
.modal-bd{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;align-items:center;justify-content:center}
.modal-bd.open{display:flex}
.modal{background:var(--panel);border:1px solid var(--border2);border-top:2px solid var(--org);border-radius:4px;padding:28px 22px;width:min(360px,calc(100vw - 32px));display:flex;flex-direction:column;gap:14px}
.modal-title{font-family:var(--font-g);font-size:18px;color:var(--org);letter-spacing:2px}
.modal-body{font-family:var(--font-m);font-size:12px;color:var(--text-dim);line-height:1.8}
.modal-body strong{color:var(--org);font-weight:400}
.modal-status{font-family:var(--font-m);font-size:11px;color:var(--green);min-height:14px}
.modal-btns{display:flex;gap:10px;flex-wrap:wrap}
.modal-btn{flex:1;padding:12px;font-family:var(--font-m);font-size:12px;font-weight:700;border-radius:3px;cursor:pointer;border:1px solid var(--border2);background:transparent;color:var(--text-dim);transition:all .2s}
.modal-btn:hover{border-color:var(--text-dim);color:var(--text)}
.modal-btn.primary{background:var(--org);color:var(--bg);border-color:var(--org)}
.modal-btn.primary:hover{background:#fbbf24}
.modal-btn.cancel{border-color:transparent;color:var(--text-faint);font-size:11px;flex:unset}
.modal-btn.cancel:hover{color:var(--text-dim);border-color:transparent}

@media(max-width:480px){.navbar{padding:0 10px}.nav-title{display:none}.nav-btn{padding:6px 10px;font-size:11px}.game-area{padding:5px 8px;gap:5px}.hud{padding:5px 10px}.tip-toast{white-space:normal;font-size:10px}}
@media(min-width:768px){.canvas-wrap{max-width:min(600px,calc(100vh - 180px))}}
    </style>
</head>
<body>

<div class="modal-bd" id="walletModal">
  <div class="modal">
    <div class="modal-title">CONNECT WALLET</div>
    <div class="modal-body">Use <strong>Freighter wallet</strong> to submit ZK-verified scores.<br>Or create a <strong>demo testnet account</strong> funded automatically.</div>
    <div class="modal-status" id="walletStatus"></div>
    <div class="modal-btns">
      <button class="modal-btn primary" id="modalFreighterBtn">Freighter</button>
      <button class="modal-btn" id="modalDemoBtn">Demo Account</button>
    </div>
    <button class="modal-btn cancel" id="modalCancelBtn">Cancel</button>
  </div>
</div>

<nav class="navbar">
  <a class="nav-brand" href="#">
    <div class="nav-logo">CS</div>
    <span class="nav-title">CHAIN SPEEDWAY</span>
  </a>
  <div class="nav-right">
    <a class="nav-btn" href="./leaderboard.html" target="_blank">üèÜ LEADERBOARD</a>
    <button class="nav-btn nav-btn-wallet" id="navWalletBtn">‚¨° WALLET</button>
  </div>
</nav>

<div class="game-area">
  <div class="hud">
    <div class="hud-item"><div class="hud-label">Level Fees</div><div class="hud-val" id="score">0</div></div>
    <div class="hud-item"><div class="hud-label">Stage</div><div class="hud-val level" id="levelDisplay">‚Äî</div></div>
    <div class="hud-item"><div class="hud-label">Speed</div><div class="hud-val speed" id="speed">‚Äî</div></div>
    <button class="hud-pause hidden" id="pauseBtn" title="Pause [ESC]">‚è∏</button>
  </div>
  <div class="fee-bar-wrap" id="feeBarWrap">
    <div class="fee-bar-track"><div class="fee-bar-fill" id="feeBarFill"></div></div>
    <div class="fee-bar-label" id="feeBarLabel">0 / 0</div>
  </div>
  <div class="canvas-wrap">
    <canvas id="gameCanvas" width="600" height="600"></canvas>
    <div class="tip-toast" id="tipToast"></div>

    <div class="overlay start-overlay" id="startScreen">
      <div class="glitch-title">CHAIN SPEEDWAY</div>
      <div class="title-sub">ZK TRANSACTION RACER ¬∑ STELLAR TESTNET</div>
      <div class="pixel-divider"></div>
      <div class="controls-hint"><span>‚Üê ‚Üí</span> switch lanes &nbsp;¬∑&nbsp; <span>üíé</span> collect gems &nbsp;¬∑&nbsp; <span>‚õî</span> dodge threats<br><span>ESC</span> pause &nbsp;¬∑&nbsp; each level score is submitted independently</div>
      <div class="start-buttons">
        <button class="btn-play" id="startOnChainBtn">‚ñ∂ PLAY ON-CHAIN</button>
        <button class="btn-guest" id="startGuestBtn">PLAY AS GUEST</button>
      </div>
      <button class="docs-link-btn" id="docsLinkBtn">What is this? / How to play</button>
    </div>

    <div class="docs-panel" id="docsPanel">
      <div class="docs-header"><div class="docs-title-txt">HOW TO PLAY</div><button class="docs-close" id="docsClose">‚úï</button></div>
      <div class="docs-sec-title">Objective</div>
      <div class="docs-txt">You are a <strong>Stellar transaction</strong> racing through the mempool. Collect <strong>fee gems</strong> to hit the level target. Each completed level submits that level's score independently.</div>
      <div class="docs-sec-title">Level Structure</div>
      <div class="docs-txt"><strong>Level 1</strong> ‚Äî Collection phase: slow speed, high gem density. Fill your fees.<br><strong>Level 2</strong> ‚Äî Balanced: faster, mixed threats and gems. Execution matters.<br><strong>Level 3</strong> ‚Äî Gauntlet: fast + sparse gems + wave obstacle patterns. Survive.</div>
      <div class="docs-sec-title">Threats</div>
      <div class="docs-txt"><strong>‚õî Double-Spend</strong> ‚Äî validator rejects duplicate txs<br><strong>üåê Congestion</strong> ‚Äî mempool backlog hits your fees<br><strong>üîë Invalid Sig</strong> ‚Äî Ed25519 mismatch, tx rejected<br><strong>ü§ñ MEV Bot</strong> ‚Äî front-run steal</div>
      <div class="docs-sec-title">ZK Scoring</div>
      <div class="docs-txt">Each level score gets a <strong>zero-knowledge proof</strong> ‚Äî proves the score is real without revealing gameplay. Rankings public. Strategies private.</div>
    </div>

    <div class="overlay countdown-overlay" id="countdownOverlay">
      <div class="countdown-num" id="countdownNum">3</div>
      <div class="countdown-sub" id="countdownSub">ENTERING MEMPOOL</div>
    </div>

    <div class="overlay pause-overlay" id="pauseOverlay">
      <div class="pause-title">PAUSED</div>
      <div class="pause-sub">PRESS ESC OR CLICK RESUME</div>
      <button class="btn-resume" id="resumeBtn">‚ñ∂ RESUME</button>
    </div>

    <div class="overlay lc-overlay" id="lcScreen">
      <div class="lc-tag" id="lcTag">LEVEL COMPLETE</div>
      <div class="lc-title" id="lcTitle">BLOCK CONFIRMED</div>
      <div class="lc-score-reveal">
        <div class="lc-score-label">Level Score</div>
        <div class="lc-score-num" id="lcScoreNum">0</div>
        <div class="lc-score-sub" id="lcScoreSub">FEES COLLECTED THIS LEVEL</div>
      </div>
      <div class="lc-lesson">
        <div class="lc-lesson-title">üì° Blockchain Concept</div>
        <div class="lc-lesson-body" id="lcLessonBody">‚Äî</div>
      </div>
      <button class="btn-continue" id="lcContinueBtn">NEXT LEVEL ‚Üí</button>
    </div>

    <div class="overlay go-overlay" id="goScreen">
      <div class="go-title">TX REJECTED</div>
      <div class="go-box">
        <div class="go-row"><span class="lbl">Levels Cleared</span><span class="val" id="goLevels">0</span></div>
        <div class="go-row"><span class="lbl">Threats Dodged</span><span class="val" id="goDodged">0</span></div>
        <div class="go-row total"><span class="lbl">Best Level Score</span><span class="val" id="goBest">0</span></div>
      </div>
      <div class="go-note" id="goNote"></div>
      <div class="go-status" id="goStatus"></div>
      <div class="go-btns">
        <button class="btn-retry" id="retryBtn">‚Ü∫ RETRY</button>
        <button class="btn-submit" id="submitBtn" disabled>SUBMIT BEST SCORE</button>
      </div>
    </div>
  </div>
</div>

<script>
const CONTRACT_ID='CA7DLSPSWKZSU425D3W5TXTPS4GQMTX5T2AFUI6TREJZWML5MIKRC54S';
const RPC_URL='https://soroban-testnet.stellar.org';
const NET_PASS='Test SDF Network ; September 2015';
const PROVER_URL='http://localhost:3002/prove';
let sessionId=null;
let wallet={connected:false,address:null,keypair:null,isGuest:false};

// ‚îÄ‚îÄ WALLET ‚îÄ‚îÄ
const navWalletBtn=document.getElementById('navWalletBtn');
const walletModal=document.getElementById('walletModal');
const walletStatus=document.getElementById('walletStatus');

function openWalletModal(){walletModal.classList.add('open');walletStatus.textContent=''}
function closeWalletModal(){walletModal.classList.remove('open')}
navWalletBtn.addEventListener('click',()=>wallet.connected?disconnectWallet():openWalletModal());
document.getElementById('modalCancelBtn').addEventListener('click',closeWalletModal);
walletModal.addEventListener('click',e=>{if(e.target===walletModal)closeWalletModal()});

document.getElementById('modalFreighterBtn').addEventListener('click',async()=>{
    walletStatus.textContent='Connecting‚Ä¶';
    try{
        if(typeof window.freighterApi!=='undefined'){
            const ok=await window.freighterApi.isConnected();
            if(ok){const pk=await window.freighterApi.getPublicKey();wallet={connected:true,address:pk,keypair:null,isGuest:false};updateWalletUI();closeWalletModal();return}
        }
        walletStatus.textContent='Freighter not found ‚Äî try Demo Account.';
    }catch(e){walletStatus.textContent='Error: '+e.message}
});

document.getElementById('modalDemoBtn').addEventListener('click',async()=>{
    walletStatus.textContent='Generating keypair‚Ä¶';
    document.getElementById('modalDemoBtn').disabled=true;
    try{
        const kp=StellarSdk.Keypair.random();
        walletStatus.textContent='Funding via Friendbot‚Ä¶';
        await fetch(`https://friendbot.stellar.org?addr=${kp.publicKey()}`);
        wallet={connected:true,address:kp.publicKey(),keypair:kp,isGuest:false};
        updateWalletUI();closeWalletModal();
    }catch(e){walletStatus.textContent='Failed: '+e.message;document.getElementById('modalDemoBtn').disabled=false}
});

function updateWalletUI(){
    if(wallet.connected){navWalletBtn.textContent='‚úì '+wallet.address.slice(0,6)+'‚Ä¶'+wallet.address.slice(-4);navWalletBtn.classList.add('connected')}
    else{navWalletBtn.textContent='‚¨° WALLET';navWalletBtn.classList.remove('connected')}
}
function disconnectWallet(){wallet={connected:false,address:null,keypair:null,isGuest:false};updateWalletUI();showTip('Wallet disconnected','',2000)}

// ‚îÄ‚îÄ TIP TOAST ‚îÄ‚îÄ
let tipTimer=null;
function showTip(msg,type='',dur=3500){
    const el=document.getElementById('tipToast');
    el.textContent=msg;el.className='tip-toast show'+(type?' '+type:'');
    clearTimeout(tipTimer);tipTimer=setTimeout(()=>el.classList.remove('show'),dur);
}
const EDU={
    doublespend:['bad','‚ö† Double-Spend: validators reject duplicate txs in milliseconds'],
    congestion: ['bad','üåê Congestion: your tx drops priority ‚Äî fees pay the penalty'],
    invalidsig: ['bad','üîë Invalid Signature: Ed25519 mismatch ‚Äî this tx was never yours'],
    mevbot:     ['bad','ü§ñ MEV Bot: front-ran your order and extracted fee value'],
    feegem:     ['good','üíé Fee collected ‚Äî validators earn this. Higher fees = faster inclusion'],
    zkboost:    ['good','‚ö° ZK Gem ‚Äî Protocol 25 priority op: speed burst granted'],
};
const eduCD={};
function eduTip(k){if(eduCD[k])return;eduCD[k]=true;const[t,m]=EDU[k]||['',''];showTip(m,t,4000);setTimeout(()=>delete eduCD[k],9000)}

// ‚îÄ‚îÄ PAUSE ‚îÄ‚îÄ
let paused=false;
const pauseBtn=document.getElementById('pauseBtn');
const pauseOverlay=document.getElementById('pauseOverlay');
function pauseGame(){if(!gs?.running)return;paused=true;gs.running=false;if(gs.animId){cancelAnimationFrame(gs.animId);gs.animId=null}pauseOverlay.classList.add('active');pauseBtn.textContent='‚ñ∂'}
function resumeGame(){if(!paused)return;paused=false;gs.running=true;pauseOverlay.classList.remove('active');pauseBtn.textContent='‚è∏';loop()}
pauseBtn.addEventListener('click',()=>paused?resumeGame():pauseGame());
document.getElementById('resumeBtn').addEventListener('click',resumeGame);
pauseOverlay.addEventListener('click',e=>{if(e.target===pauseOverlay)resumeGame()});
document.addEventListener('keydown',e=>{
    if(e.key==='Escape'){
        if(document.getElementById('docsPanel').classList.contains('open')){document.getElementById('docsPanel').classList.remove('open');return}
        if(!gs||(!gs.running&&!paused))return;
        paused?resumeGame():pauseGame();
    }
});

// ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const scoreEl=document.getElementById('score');
const speedEl=document.getElementById('speed');
const levelEl=document.getElementById('levelDisplay');
const LANE_N=3,LW=canvas.width/3;
const LANE_X=[LW/2,canvas.width/2,canvas.width-LW/2];
const LANE_NAMES=['SLOW','MED','FAST'];
const LANE_BG=['rgba(245,158,11,0.05)','rgba(245,158,11,0.03)','rgba(239,68,68,0.04)'];
const THREATS=[
    {id:'doublespend',label:'DBL-SPEND',color:'#ef4444'},
    {id:'congestion', label:'CONGESTION',color:'#f97316'},
    {id:'invalidsig', label:'INV-SIG',  color:'#8b5cf6'},
    {id:'mevbot',     label:'MEV BOT',  color:'#ec4899'},
];

// ‚îÄ‚îÄ LEVEL SYSTEM ‚Äî differentiated per level ‚îÄ‚îÄ
// L1=Collection (slow+high gems), L2=Balanced, L3=Gauntlet (fast+sparse gems+waves)
const SETS=[
    {name:'FEE WARS',levels:[
        {label:'S1-L1',speed:.85,target:200,gemRate:.018,obstRate:.22,maxBlock:1,dmg:.10,mode:'COLLECTION'},
        {label:'S1-L2',speed:1.2,target:350,gemRate:.010,obstRate:.45,maxBlock:1,dmg:.15,mode:'BALANCED'},
        {label:'S1-L3',speed:1.6,target:500,gemRate:.005,obstRate:.72,maxBlock:2,dmg:.20,mode:'GAUNTLET'},
    ]},
    {name:'SPEED & FEES',levels:[
        {label:'S2-L1',speed:1.4,target:300,gemRate:.016,obstRate:.28,maxBlock:1,dmg:.22,mode:'COLLECTION'},
        {label:'S2-L2',speed:1.9,target:500,gemRate:.009,obstRate:.55,maxBlock:2,dmg:.30,mode:'BALANCED'},
        {label:'S2-L3',speed:2.6,target:750,gemRate:.004,obstRate:.82,maxBlock:2,dmg:.38,mode:'GAUNTLET'},
    ]},
    {name:'ZK PRESSURE',levels:[
        {label:'S3-L1',speed:2.0,target:400,gemRate:.014,obstRate:.34,maxBlock:1,dmg:.45,mode:'COLLECTION'},
        {label:'S3-L2',speed:2.8,target:650,gemRate:.008,obstRate:.65,maxBlock:2,dmg:.55,mode:'BALANCED'},
        {label:'S3-L3',speed:3.7,target:950,gemRate:.003,obstRate:.92,maxBlock:2,dmg:.65,mode:'GAUNTLET'},
    ]},
    {name:'VALIDATOR WARS',levels:[
        {label:'F-L1', speed:2.6,target:500,gemRate:.012,obstRate:.46,maxBlock:2,dmg:.75,mode:'BALANCED'},
        {label:'F-L2', speed:3.6,target:850,gemRate:.006,obstRate:.82,maxBlock:2,dmg:.88,mode:'GAUNTLET'},
        {label:'F-L3', speed:4.8,target:1300,gemRate:.003,obstRate:.95,maxBlock:2,dmg:.95,mode:'GAUNTLET'},
    ]},
];

const LESSONS={
    '0-0':{tag:'orange',title:'MEMPOOL ENTRY CLEARED',lesson:'<strong>Transaction fees</strong> are bids for block space. Validators pick highest-fee txs first ‚Äî you\'ve been running that auction.'},
    '0-1':{tag:'orange',title:'STANDARD LANE CLEARED',lesson:'<strong>Fee markets:</strong> when network is congested, fees spike. Validators earn more, users pay more ‚Äî the price of priority.'},
    '0-2':{tag:'orange',title:'FEE WARS DONE',lesson:'<strong>Layer 2 networks</strong> batch txs off-chain and post one compressed proof to L1. Stellar Protocol 25 adds native ZK infrastructure for exactly this.'},
    '1-0':{tag:'orange',title:'L2 ENTRY CLEARED',lesson:'<strong>ZK Rollups</strong> prove tx validity instantly ‚Äî no 7-day fraud window. Stellar\'s 5-second ledger close means ZK proofs settle faster than any EVM chain.'},
    '1-1':{tag:'orange',title:'ROLLUP LANE CLEARED',lesson:'<strong>Most bridges</strong> have 7-day fraud windows. ZK bridges settle in minutes. Soroban + ZK enables atomic cross-chain swaps with zero wait.'},
    '1-2':{tag:'orange',title:'SPEED & FEES DONE',lesson:'<strong>Zero-knowledge proofs</strong> prove you know something without revealing it. Your score was proven on-chain without exposing a single move.'},
    '2-0':{tag:'green',title:'PROOF LOAD SURVIVED',lesson:'<strong>Proof generation</strong> takes real compute. L2 operators charge fees because they pay for proof generation on every batch they submit.'},
    '2-1':{tag:'green',title:'PROVER CLEARED',lesson:'<strong>Recursive ZK</strong> proves thousands of txs in one tiny proof. RISC Zero zkVM runs game logic and proves it was correct ‚Äî verifiable on-chain.'},
    '2-2':{tag:'green',title:'ZK PRESSURE DONE',lesson:'<strong>MEV bots</strong> reorder and front-run txs to steal fees. Encrypted mempools using ZK proofs make front-running cryptographically impossible.'},
    '3-0':{tag:'red',title:'CONSENSUS SURVIVED',lesson:'<strong>Stellar SCP</strong> ‚Äî Federated Byzantine Agreement: no mining, no staking. Consensus in ~5 seconds with global validator nodes.'},
    '3-1':{tag:'red',title:'VALIDATOR RACE CLEARED',lesson:'<strong>Protocol 25</strong> brings native ZK to Soroban: private DeFi, verifiable gaming, ZK identity ‚Äî on 5-second finality + sub-cent fees.'},
};

function getLv(){return SETS[gs?.set]?.levels[gs?.level]||null}
function rand(a,b){return a+Math.random()*(b-a)}

// ‚îÄ‚îÄ RANDOMIZED SPAWNER ‚îÄ‚îÄ
function makeSpawner(lv){
    return{nextFire:Date.now()+rand(300,700),waveAt:Date.now()+rand(12000,22000)}
}

// Weighted lane: FAST lane gets more threats
const LANE_W=[25,35,40];
function weightedLane(exclude=[]){
    const pool=[0,1,2].filter(i=>!exclude.includes(i)&&!gs.threats.some(o=>o.lane===i&&o.y>-160));
    if(!pool.length)return -1;
    const tot=pool.reduce((s,l)=>s+LANE_W[l],0);
    let r=Math.random()*tot;
    for(const l of pool){r-=LANE_W[l];if(r<=0)return l}
    return pool[pool.length-1];
}

// Threat type weighted by set (later sets = worse threats)
const SET_WEIGHTS=[[40,30,20,10],[25,30,25,20],[15,20,30,35],[10,15,30,45]];
function pickThreat(){
    const w=SET_WEIGHTS[Math.min(gs.set,3)];
    let r=Math.random()*100;
    for(let i=0;i<4;i++){r-=w[i];if(r<=0)return THREATS[i].id}
    return THREATS[3].id;
}

function spawnThreats(){
    if(!gs.running)return;
    const now=Date.now();const lv=getLv();if(!lv)return;

    // WAVE EVENT
    if(now>=gs.spawner.waveAt&&lv.mode!=='COLLECTION'){
        const lanes=[0,1,2].filter(i=>!gs.threats.some(o=>o.lane===i&&o.y>-200));
        const count=Math.min(lanes.length,lv.maxBlock);
        const sh=lanes.sort(()=>Math.random()-.5);
        const tp=pickThreat();
        for(let i=0;i<count;i++){
            const delay=i*rand(60,140);
            setTimeout(()=>{if(gs&&gs.running)gs.threats.push({x:LANE_X[sh[i]],y:-30,lane:sh[i],type:tp,hit:false})},delay);
        }
        gs.spawner.waveAt=now+rand(15000,26000);
        return;
    }

    if(now<gs.spawner.nextFire)return;
    // Random varied gap
    gs.spawner.nextFire=now+rand(160,480)/lv.speed;
    if(Math.random()>lv.obstRate)return;

    const l1=weightedLane([]);
    if(l1===-1)return;
    gs.threats.push({x:LANE_X[l1],y:-30,lane:l1,type:pickThreat(),hit:false});

    // Second lane block in gauntlet/balanced
    if(lv.maxBlock>=2&&Math.random()<0.32){
        const l2=weightedLane([l1]);
        if(l2!==-1){
            const stagger=rand(80,220);
            setTimeout(()=>{if(gs&&gs.running)gs.threats.push({x:LANE_X[l2],y:-30-rand(10,50),lane:l2,type:pickThreat(),hit:false})},stagger);
        }
    }
}

function spawnGems(){
    const lv=getLv();if(!lv)return;
    if(Math.random()<lv.gemRate){
        // In gauntlet, gems skew toward safer lanes
        const lc=lv.mode==='GAUNTLET'?[50,35,15]:[33,34,33];
        let r=Math.random()*100,lane=2;
        for(let i=0;i<3;i++){r-=lc[i];if(r<=0){lane=i;break}}
        gs.gems.push({x:LANE_X[lane],y:-20,lane,pulse:0,hit:false,isZK:Math.random()<.14});
    }
}

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ
function drawRoad(){
    ctx.fillStyle='#050408';ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let i=0;i<3;i++){ctx.fillStyle=LANE_BG[i];ctx.fillRect(LW*i,0,LW,canvas.height)}
    ctx.fillStyle='rgba(245,158,11,0.06)';
    for(let i=0;i<14;i++){const x=(i*47+gs.roadOff*.3)%canvas.width,y=(i*83+gs.roadOff*2.4)%canvas.height;ctx.fillRect(x,y,1,5)}
    ctx.strokeStyle='rgba(42,30,60,0.9)';ctx.lineWidth=1;ctx.setLineDash([16,14]);ctx.lineDashOffset=-gs.roadOff;
    for(let i=1;i<3;i++){ctx.beginPath();ctx.moveTo(LW*i,0);ctx.lineTo(LW*i,canvas.height);ctx.stroke()}
    ctx.setLineDash([]);
    ctx.strokeStyle='rgba(28,20,40,1)';ctx.lineWidth=3;
    ctx.beginPath();ctx.moveTo(2,0);ctx.lineTo(2,canvas.height);ctx.stroke();
    ctx.beginPath();ctx.moveTo(canvas.width-2,0);ctx.lineTo(canvas.width-2,canvas.height);ctx.stroke();
    ctx.font='9px Russo One,sans-serif';ctx.textAlign='center';
    const lc=['rgba(245,158,11,0.4)','rgba(245,158,11,0.3)','rgba(239,68,68,0.4)'];
    for(let i=0;i<3;i++){ctx.fillStyle=lc[i];ctx.fillText(LANE_NAMES[i],LANE_X[i],13)}
    if(gs.running){gs.roadOff+=5*gs.speed;if(gs.roadOff>36)gs.roadOff=0}
}

function drawPlayer(x,y){
    const gr=ctx.createLinearGradient(x-20,y,x+20,y+70);
    gr.addColorStop(0,'#120d1e');gr.addColorStop(1,'#0a0814');
    ctx.fillStyle=gr;ctx.fillRect(x-20,y+8,40,58);
    ctx.fillStyle='#f59e0b';ctx.fillRect(x-12,y,24,10);
    ctx.fillStyle='rgba(245,158,11,0.5)';ctx.fillRect(x-20,y+20,3,32);ctx.fillRect(x+17,y+20,3,32);
    ctx.fillStyle='rgba(245,158,11,0.22)';
    [18,26,34,42].forEach(dy=>ctx.fillRect(x-14,y+dy,28,1));
    ctx.fillStyle='#0e0818';ctx.fillRect(x-20,y+58,40,12);
    const fl=5+Math.floor(Math.random()*6);
    ctx.fillStyle='#f59e0b';ctx.fillRect(x-16,y+70,10,fl);ctx.fillRect(x+6,y+70,10,fl);
    ctx.fillStyle='rgba(251,191,36,0.6)';ctx.fillRect(x-13,y+70+fl,5,3);ctx.fillRect(x+9,y+70+fl,5,3);
}

function drawThreat(x,y,type){
    const t=THREATS.find(t=>t.id===type)||THREATS[0];
    ctx.fillStyle=t.color+'18';ctx.strokeStyle=t.color+'cc';ctx.lineWidth=1;
    ctx.beginPath();ctx.roundRect(x-38,y-16,76,32,3);ctx.fill();ctx.stroke();
    ctx.fillStyle=t.color;ctx.font='bold 9px Share Tech Mono,monospace';ctx.textAlign='center';
    ctx.fillText(t.label,x,y+4);
}

function drawGem(x,y,pulse,isZK){
    const col=isZK?'#8b5cf6':'#f59e0b',s=11+Math.sin(pulse)*1.5;
    ctx.fillStyle=col+'cc';
    ctx.beginPath();ctx.moveTo(x,y-s);ctx.lineTo(x+s*.55,y);ctx.lineTo(x,y+s);ctx.lineTo(x-s*.55,y);ctx.closePath();ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.28)';
    ctx.beginPath();ctx.moveTo(x,y-s*.5);ctx.lineTo(x+s*.22,y-s*.08);ctx.lineTo(x,y+s*.18);ctx.lineTo(x-s*.22,y-s*.08);ctx.closePath();ctx.fill();
    if(isZK){ctx.fillStyle='#fff';ctx.font='7px Share Tech Mono,monospace';ctx.textAlign='center';ctx.fillText('ZK',x,y+2)}
}

function drawFloats(){
    gs.floats.forEach(f=>{ctx.globalAlpha=f.opacity;ctx.fillStyle=f.color;ctx.font='bold 14px Russo One,sans-serif';ctx.textAlign='center';ctx.fillText(f.text,f.x,f.y);ctx.globalAlpha=1});
}
function spawnFloat(x,y,text,color){gs.floats.push({x,y,text,color,opacity:1,vy:-2,life:55})}

function updateHUD(){
    const lv=getLv();if(!lv)return;
    levelEl.textContent=lv.label;speedEl.textContent=gs.speed.toFixed(2)+'x';
    const pct=Math.min(100,(gs.levelFees/lv.target)*100);
    document.getElementById('feeBarFill').style.width=pct+'%';
    document.getElementById('feeBarLabel').textContent=Math.floor(gs.levelFees)+' / '+lv.target+' ‚Äî '+lv.mode;
    canvas.classList.toggle('danger',gs.levelFees<30&&gs.levelFees>0);
}

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ
let gs=null;
const player={w:48,h:78,y:430,targetX:LANE_X[1],currentX:LANE_X[1]};

function update(){
    if(!gs.running)return;
    gs.actions.push(gs.pendingAction);gs.pendingAction=0;
    const d=player.targetX-player.currentX;
    if(Math.abs(d)>1)player.currentX+=d*.25;else player.currentX=player.targetX;
    const lv=getLv();

    gs.threats.forEach(o=>{
        o.y+=5*gs.speed;
        if(!o.hit&&o.y+18>player.y&&o.y-18<player.y+player.h&&o.lane===gs.playerLane&&Math.abs(player.currentX-o.x)<42){
            o.hit=true;
            const dmg=Math.max(5,Math.floor(gs.levelFees*lv.dmg));
            gs.levelFees=Math.max(0,gs.levelFees-dmg);
            scoreEl.textContent=Math.floor(gs.levelFees);
            spawnFloat(player.currentX,player.y-10,'-'+dmg,'#ef4444');
            eduTip(o.type);updateHUD();
            if(gs.levelFees<=0){gs.running=false;spawnFloat(player.currentX,player.y-40,'REJECTED','#ef4444');draw();setTimeout(gameOver,900)}
        }
        if(!o.hit&&o.y>player.y+player.h){o.hit=true;gs.dodged++}
    });
    gs.threats=gs.threats.filter(o=>o.y<canvas.height+70);

    gs.gems.forEach(g=>{
        g.y+=5*gs.speed;g.pulse+=.12;
        if(!g.hit&&g.y+18>player.y&&g.y-18<player.y+player.h&&g.lane===gs.playerLane&&Math.abs(player.currentX-g.x)<38){
            g.hit=true;
            const bonus=g.isZK?50:10;
            gs.levelFees+=bonus;scoreEl.textContent=Math.floor(gs.levelFees);
            spawnFloat(g.x,g.y,(g.isZK?'+50 ZK':'+10'),g.isZK?'#8b5cf6':'#f59e0b');
            eduTip(g.isZK?'zkboost':'feegem');
            if(g.isZK){gs.speed=Math.min(gs.speed+.1,5.5);speedEl.textContent=gs.speed.toFixed(2)+'x'}
            updateHUD();
        }
    });
    gs.gems=gs.gems.filter(g=>!g.hit&&g.y<canvas.height+60);

    gs.floats.forEach(f=>{f.y+=f.vy;f.vy*=.94;f.life--;f.opacity=Math.max(0,f.life/40)});
    gs.floats=gs.floats.filter(f=>f.life>0);

    spawnThreats();spawnGems();
    if(lv&&gs.levelFees>=lv.target)advanceLevel();
}

function draw(){
    drawRoad();
    gs.threats.forEach(o=>{if(!o.hit)drawThreat(o.x,o.y,o.type)});
    gs.gems.forEach(g=>{if(!g.hit)drawGem(g.x,g.y,g.pulse,g.isZK)});
    drawPlayer(player.currentX,player.y);
    drawFloats();
}

function loop(){update();draw();if(gs.running)gs.animId=requestAnimationFrame(loop)}

// ‚îÄ‚îÄ LEVEL ADVANCE ‚îÄ‚îÄ
async function advanceLevel(){
    gs.running=false;
    if(gs.animId){cancelAnimationFrame(gs.animId);gs.animId=null}
    const fromSet=gs.set,fromLv=gs.level;
    const levelScore=Math.floor(gs.levelFees);
    if(levelScore>gs.bestLevelScore)gs.bestLevelScore=levelScore;
    gs.levelsCleared++;

    const key=`${fromSet}-${fromLv}`;
    const data=LESSONS[key]||{tag:'orange',title:'LEVEL COMPLETE',lesson:'Keep going.'};
    document.getElementById('lcTag').textContent=data.title;
    document.getElementById('lcTag').className=`lc-tag ${data.tag}`;
    document.getElementById('lcTitle').textContent=data.title;
    document.getElementById('lcScoreNum').textContent=levelScore.toLocaleString();
    document.getElementById('lcScoreSub').textContent='LEVEL '+SETS[fromSet].levels[fromLv].label+' ‚Äî '+SETS[fromSet].levels[fromLv].mode;
    document.getElementById('lcLessonBody').innerHTML=data.lesson;
    document.getElementById('lcScreen').classList.add('active');

    if(!wallet.isGuest&&wallet.connected)submitLevelScore(levelScore,SETS[fromSet].levels[fromLv].label).catch(console.warn);

    const btn=document.getElementById('lcContinueBtn');
    const handler=()=>{
        btn.removeEventListener('click',handler);
        document.getElementById('lcScreen').classList.remove('active');
        const nLv=fromLv+1,lastSet=fromSet>=SETS.length-1,lastLv=nLv>=SETS[fromSet].levels.length;
        if(lastLv&&lastSet){showTip('üèÜ LEGENDARY VALIDATOR! Full mempool conquered!','good',6000);setTimeout(gameOver,6200);return}
        if(lastLv){gs.set++;gs.level=0}else{gs.level=nLv}
        gs.levelFees=0;const lv2=getLv();
        gs.speed=lv2.speed;scoreEl.textContent='0';speedEl.textContent=lv2.speed.toFixed(2)+'x';
        gs.spawner=makeSpawner(lv2);updateHUD();
        runCountdown(lv2.label+' ‚Äî '+lv2.mode,()=>{gs.running=true;loop()});
    };
    btn.addEventListener('click',handler);
}

function runCountdown(sub,cb){
    const ov=document.getElementById('countdownOverlay'),numEl=document.getElementById('countdownNum');
    document.getElementById('countdownSub').textContent=sub;ov.classList.add('active');
    const steps=['3','2','1','GO!'];let i=0;
    function step(){
        if(i>=steps.length){ov.classList.remove('active');cb();return}
        numEl.textContent=steps[i];numEl.className='countdown-num'+(steps[i]==='GO!'?' go':'');
        numEl.style.animation='none';void numEl.offsetHeight;numEl.style.animation='';
        i++;setTimeout(step,steps[i-1]==='GO!'?650:850);
    }
    step();
}

function gameOver(){
    gs.running=false;canvas.classList.remove('danger');
    if(gs.animId){cancelAnimationFrame(gs.animId);gs.animId=null}
    paused=false;pauseBtn.classList.add('hidden');pauseOverlay.classList.remove('active');
    document.getElementById('goLevels').textContent=gs.levelsCleared;
    document.getElementById('goDodged').textContent=gs.dodged;
    document.getElementById('goBest').textContent=gs.bestLevelScore.toLocaleString();
    const btn=document.getElementById('submitBtn'),note=document.getElementById('goNote');
    if(wallet.isGuest){note.innerHTML='Guest scores are not recorded on-chain.';btn.disabled=true}
    else if(wallet.connected){note.innerHTML='<strong>ZK proofs</strong> auto-submitted per level. Use this to re-submit your best.';btn.disabled=false}
    else{note.innerHTML='Connect wallet to submit scores.';btn.disabled=true}
    document.getElementById('goStatus').textContent='';
    document.getElementById('goScreen').classList.add('active');
}

function startGame(){
    paused=false;if(gs?.animId)cancelAnimationFrame(gs.animId);
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('goScreen').classList.remove('active');
    document.getElementById('lcScreen').classList.remove('active');
    canvas.classList.remove('danger');pauseBtn.classList.remove('hidden');
    const lv0=SETS[0].levels[0];
    gs={running:false,levelFees:0,dodged:0,bestLevelScore:0,levelsCleared:0,set:0,level:0,speed:lv0.speed,roadOff:0,playerLane:1,threats:[],gems:[],floats:[],animId:null,seed:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER),actions:[],pendingAction:0,spawner:makeSpawner(lv0)};
    player.currentX=LANE_X[1];player.targetX=LANE_X[1];
    scoreEl.textContent='0';speedEl.textContent=lv0.speed.toFixed(2)+'x';levelEl.textContent=lv0.label;
    document.getElementById('feeBarWrap').style.display='block';
    document.getElementById('feeBarFill').style.width='0%';
    updateHUD();drawRoad();drawPlayer(player.currentX,player.y);
    if(wallet.connected&&wallet.keypair)startOnChain().catch(console.warn);
    runCountdown('S1-L1 ‚Äî COLLECTION',()=>{gs.running=true;pauseBtn.textContent='‚è∏';loop()});
}

// ‚îÄ‚îÄ STELLAR ‚îÄ‚îÄ
async function callContract(method,args){
    if(!wallet.keypair)throw new Error('No keypair');
    const srv=new StellarSdk.SorobanRpc.Server(RPC_URL);
    const acct=await srv.getAccount(wallet.address);
    const ct=new StellarSdk.Contract(CONTRACT_ID);
    const tx=new StellarSdk.TransactionBuilder(acct,{fee:StellarSdk.BASE_FEE,networkPassphrase:NET_PASS}).addOperation(ct.call(method,...args)).setTimeout(30).build();
    const prep=await srv.prepareTransaction(tx);prep.sign(wallet.keypair);
    return srv.sendTransaction(prep);
}
async function startOnChain(){sessionId=(()=>{const b=new Uint32Array(1);crypto.getRandomValues(b);return b[0]||1})();await callContract('start_game',[StellarSdk.nativeToScVal(sessionId,{type:'u32'}),StellarSdk.Address.fromString(wallet.address).toScVal()])}
async function genProof(score){try{const r=await fetch(PROVER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({seed:gs.seed,actions:gs.actions,player_address:wallet.address})});if(!r.ok)throw new Error(r.status);return await r.json()}catch{return{seal:'00'.repeat(64),journal:'00'.repeat(32)}}}
async function submitLevelScore(score,label){
    try{
        const proof=await genProof(score);
        if(wallet.keypair&&sessionId){
            const h2b=h=>new Uint8Array(h.match(/.{1,2}/g).map(b=>parseInt(b,16)));
            const pv=StellarSdk.xdr.ScVal.scvMap([new StellarSdk.xdr.ScMapEntry({key:StellarSdk.xdr.ScVal.scvSymbol('seal'),val:StellarSdk.xdr.ScVal.scvBytes(h2b(proof.seal))}),new StellarSdk.xdr.ScMapEntry({key:StellarSdk.xdr.ScVal.scvSymbol('journal'),val:StellarSdk.xdr.ScVal.scvBytes(h2b(proof.journal))})]);
            await callContract('submit_score',[StellarSdk.nativeToScVal(sessionId,{type:'u32'}),StellarSdk.Address.fromString(wallet.address).toScVal(),StellarSdk.nativeToScVal(score,{type:'u32'}),pv]);
        }
        showTip('‚úì Level '+label+' score submitted to Stellar','good',3000);
    }catch(e){console.warn('Submit:',e.message)}
}

document.getElementById('submitBtn').addEventListener('click',async()=>{
    const score=gs.bestLevelScore,status=document.getElementById('goStatus'),btn=document.getElementById('submitBtn');
    btn.disabled=true;status.textContent='üîê Generating ZK proof‚Ä¶';
    try{await submitLevelScore(score,'BEST');status.textContent='‚úì Submitted.';setTimeout(()=>{status.textContent='';btn.disabled=false},3000)}
    catch(e){status.textContent='‚úó '+e.message;btn.disabled=false}
});

// ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ
document.addEventListener('keydown',e=>{
    if(!gs?.running)return;
    if(e.key==='ArrowLeft'&&gs.playerLane>0){gs.playerLane--;player.targetX=LANE_X[gs.playerLane];gs.pendingAction=1}
    else if(e.key==='ArrowRight'&&gs.playerLane<2){gs.playerLane++;player.targetX=LANE_X[gs.playerLane];gs.pendingAction=2}
});
let touchX=0;
canvas.addEventListener('touchstart',e=>{touchX=e.touches[0].clientX});
canvas.addEventListener('touchend',e=>{
    const d=e.changedTouches[0].clientX-touchX;if(Math.abs(d)<28)return;
    if(d<0&&gs.playerLane>0){gs.playerLane--;player.targetX=LANE_X[gs.playerLane];gs.pendingAction=1}
    else if(d>0&&gs.playerLane<2){gs.playerLane++;player.targetX=LANE_X[gs.playerLane];gs.pendingAction=2}
});

// ‚îÄ‚îÄ DOCS + NAV ‚îÄ‚îÄ
document.getElementById('docsLinkBtn').addEventListener('click',()=>document.getElementById('docsPanel').classList.add('open'));
document.getElementById('docsClose').addEventListener('click',()=>document.getElementById('docsPanel').classList.remove('open'));
document.getElementById('startOnChainBtn').addEventListener('click',()=>{
    if(!wallet.connected){openWalletModal();const poll=setInterval(()=>{if(wallet.connected){clearInterval(poll);closeWalletModal();wallet.isGuest=false;startGame()}},400);setTimeout(()=>clearInterval(poll),120000);return}
    wallet.isGuest=false;startGame();
});
document.getElementById('startGuestBtn').addEventListener('click',()=>{wallet.isGuest=true;startGame()});
document.getElementById('retryBtn').addEventListener('click',()=>{document.getElementById('goScreen').classList.remove('active');document.getElementById('startScreen').classList.remove('hidden');pauseBtn.classList.add('hidden')});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
gs={running:false,roadOff:0,threats:[],gems:[],floats:[],speed:1,playerLane:1,levelFees:0,dodged:0,bestLevelScore:0,levelsCleared:0,set:0,level:0,animId:null,seed:0,actions:[],pendingAction:0,spawner:{nextFire:0,waveAt:0}};
drawRoad();drawPlayer(LANE_X[1],player.y);
</script>
</body>
</html>